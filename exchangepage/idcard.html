<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thammue – เปิดร้านค้า</title>
    <link rel="stylesheet" href="/css/instyle.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/open-shop.css" />
    <style>
      .open-shop .field.required > label::before{content:"* ";color:#d0342c;font-weight:600;}
      .open-shop .field label:has(+ .dob-row select[required]){position:relative;padding-left:12px;}
      .open-shop .field label:has(+ .dob-row select[required])::before{content:"*";position:absolute;left:0;top:0;color:#d0342c;font-weight:600;}
    </style>
        <style>
        /* flash fade in/out */
        #flash {
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity .35s ease, transform .35s ease
        }

        #flash.show {
            opacity: 1;
            transform: translateY(0)
        }

        #flash.hide {
            opacity: 0;
            transform: translateY(-4px)
        }

        /* ชื่อผู้ใช้ถัดจากไอคอน */
        .icon-buttons .user-area {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            text-decoration: none
        }

        .icon-buttons .user-area img {
            height: 26px;
            width: auto;
            display: block
        }

        .icon-buttons .user-chip {
            color: #fff;
            font-size: 14px;
            opacity: .9;
            max-width: 140px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .icon-buttons .user-area:hover .user-chip {
            opacity: 1
        }

        @media (max-width:640px) {
            .icon-buttons .user-chip {
                display: none
            }
        }

        .logout-btn img {
            height: 22px;
            width: auto;
            filter: invert(100%)
        }
    </style>

</head>

<body>
    <!-- แถบบนสุด -->
    <ul class="top-nav">
        <!-- ซ้าย -->
        <li><a href="/exchangepage/Uplode.html">อัพโหลดสินค้าแลกเปลี่ยน</a></li>
        <li><span class="top-divider">|</span></li>
        <li><a href="/page/main.html">ซื้อสินค้า</a></li>

        <!-- ขวา -->
        <li class="right"><a href="#notification">แจ้งเตือน</a></li>
        <li><span class="top-divider">|</span></li>
        <li><a href="#help">ช่วยเหลือ</a></li>
        <li><span class="top-divider">|</span></li>
        <li><a href="#lang">ไทย</a></li>
    </ul>
    <!-- Header หลัก -->
    <div class="header-wrapper">
        <div class="logo-container">
            <a href="/exchangepage/index.html" class="brand-text">THAMMUE</a>
        </div>

        <div class="search-container">
            <div class="search-group">
                <input type="text" placeholder="ค้นหาสินค้า" />
                <button class="search-button" aria-label="ค้นหา">
                    <img src="/img/Icon/search.png" alt="ค้นหา" />
                </button>
            </div>

            <div class="icon-buttons desktop-icons">
                <a class="action-button" href="/exchangepage/Request.html" aria-label="คำขอแลกเปลี่ยน">
                    <img src="/img/Icon/exchange.png" alt="">
                </a>

                <a class="action-button" href="/exchangepage/fav.html" aria-label="รายการโปรด">
                    <img src="/img/Icon/heart.png" alt="">
                </a>

                <a class="action-button" href="/exchangepage/chat.html" aria-label="แชท">
                    <img src="/img/Icon/chat.png" alt="">
                </a>

                <!-- ▼ โปรไฟล์ + ชื่อ + เมนูดรอปดาวน์ -->
                <div class="user-menu" id="userMenu">
                    <!---กล่องรวมปุ่มโปรไฟล์ + เมนูดรอปดาวน์ -->

                    <button class="user-area" id="userArea" aria-haspopup="true" aria-expanded="false">
                        <!---userArea ที่ไว้ เปิด ปิดเมนู-->

                        <img src="/img/Icon/user.png" alt="โปรไฟล์" />
                        <span class="user-chip" id="userChip" hidden></span>
                        <!---userChip ที่ไว้โชว์ชื่อผู้ใช้-->
                        <svg class="chev" viewBox="0 0 20 20" aria-hidden="true">
                            <!---ตัวเลขเป็นพิกัดวาดรูปลูกศร ชี้ลง-->
                            <path d="M5.5 7.5l4.5 4 4.5-4" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>

                    <div class="user-dropdown" id="userDropdown" role="menu">
                        <!-- JS จะเติมรายการให้หลังจาก login/logout -->
                    </div>
                </div>
            </div>
            <button class="hamburger" aria-label="เปิดเมนู" aria-controls="mobileIcons" aria-expanded="false">
                <img src="/img/Icon/menu.png" alt="" aria-hidden="true">
            </button>
        </div>
    </div>


    <nav id="mobileIcons" class="icons-drawer" hidden>
        <button class="icons-drawer__close" aria-label="ปิดเมนู">✕</button>
        <a href="/exchangepage/Request.html"><img src="/img/Icon/exchange.png" alt=""> คำขอแลกเปลี่ยน</a>
        <a href="/exchangepage/fav.html"><img src="/img/Icon/heart.png" alt=""> รายการโปรด</a>
        <a href="/exchangepage/chat.html"><img src="/img/Icon/chat.png" alt=""> แชท</a>
        <a href="/exchangepage/profile.html"><img src="/img/Icon/user.png" alt=""> โปรไฟล์</a>
    </nav>
    <div class="icons-backdrop" hidden></div>

    <div class="category-buttons">
        <a href="/exchangepage/category/Electronics.html" class="category-button">อุปกรณ์อิเล็กทรอนิกส์</a>
        <a href="/exchangepage/category/homeappliances.html" class="category-button">ของใช้ในบ้าน</a>
        <a href="/exchangepage/category/children's.html" class="category-button">อุปกรณ์เด็ก</a>
        <a href="/exchangepage/category/clothing.html" class="category-button">เสื้อผ้า</a>
        <a href="/exchangepage/category/books.html" class="category-button">หนังสือ</a>
        <a href="/exchangepage/category/collectibles.html" class="category-button">ของสะสม</a>
    </div>
    </div>
  </head>
  <body class="open-shop">

    <main class="wizard-page">
      <section class="wizard-card">
        <!-- ลบ stepper ออก: เหลือฟอร์มเดียว -->
        <h2 class="form-section">ยืนยันตัวตน</h2>

        <!-- ฟอร์มเดียว: ยืนยันตัวตน (บุคคลธรรมดา) -->
        <form id="openShopForm"
              action="/page/backend/save_open_shop.php"
              method="post"
              enctype="multipart/form-data"
              autocomplete="off">

          <div class="field">
            <label for="citizen_name">ชื่อ-นามสกุล</label>
            <input id="citizen_name" name="citizen_name" type="text" required />
          </div>

          <div class="field required">
            <label>วันเดือนปีเกิด</label>
            <div class="dob-row" style="display:flex; gap:10px; align-items:center;">
              <select id="dobDay" aria-label="วัน" required></select>
              <select id="dobMonth" aria-label="เดือน" required></select>
              <select id="dobYearBE" aria-label="พ.ศ." required></select>
            </div>
            <input type="hidden" name="dob_iso" id="dobIso" />
            <div class="hint" id="dobHint" hidden>กรุณาเลือกวันเดือนปีเกิดให้ถูกต้อง (อายุ 18+)</div>
          </div>

          <div class="field">
            <label for="citizen_id">เลขบัตรประชาชน (13 หลัก)</label>
            <input id="citizen_id" name="citizen_id" inputmode="numeric" maxlength="13" pattern="\d{13}" required />
          </div>

          <h3 class="form-section">ที่อยู่ตามบัตรประชาชน</h3>

          <div class="grid2">
            <div class="field">
              <label for="cid_province">จังหวัด</label>
              <select id="cid_province" name="cid_province" required>
                <option value selected disabled>— เลือกจังหวัด —</option>
              </select>
            </div>
            <div class="field">
              <label for="cid_district">อำเภอ/เขต</label>
              <select id="cid_district" name="cid_district" required>
                <option value selected disabled>— เลือกอำเภอ/เขต —</option>
              </select>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="cid_subdistrict">ตำบล/แขวง</label>
              <select id="cid_subdistrict" name="cid_subdistrict" required>
                <option value selected disabled>— เลือกตำบล/แขวง —</option>
              </select>
            </div>
            <div class="field">
              <label for="postcode">รหัสไปรษณีย์</label>
              <input id="postcode" name="postcode" inputmode="numeric" maxlength="5" required />
            </div>
          </div>

          <div class="field">
            <label for="addr_line">รายละเอียดที่อยู่ตามบัตร</label>
            <input id="addr_line" name="addr_line" placeholder="บ้านเลขที่ หมู่ ซอย ถนน" required />
          </div>

          <div class="grid2">
            <div class="field">
              <label for="id_front">บัตรประชาชนด้านหน้า</label>
              <input type="file" id="id_front" name="id_front" accept="image/*,application/pdf" required />
            </div>
          </div>

          <div class="actions">
            <button type="submit" class="btn">ส่งแบบฟอร์ม</button>
          </div>
        </form>
      </section>
    </main>

    <!-- โหลดตัวช่วยที่อยู่ไทย -->
    <script src="/exchangepage/js/address.js"></script>

    <script>
      // จำกัดอินพุตตัวเลข
      const citizenIdInput = document.getElementById('citizen_id');
      citizenIdInput?.addEventListener('input', () => {
        citizenIdInput.value = citizenIdInput.value.replace(/\D/g,'').slice(0,13);
      });
      const postcodeInput = document.getElementById('postcode');
      postcodeInput?.addEventListener('input', () => {
        postcodeInput.value = postcodeInput.value.replace(/\D/g,'').slice(0,5);
      });

      // DOB
      const $dobDay   = document.getElementById('dobDay');
      const $dobMonth = document.getElementById('dobMonth');
      const $dobYearB = document.getElementById('dobYearBE');
      const $dobIso   = document.getElementById('dobIso');
      const $dobHint  = document.getElementById('dobHint');

      function fillDays(){
        if (!$dobDay) return;
        $dobDay.innerHTML = '<option value="">วัน</option>';
        for (let d=1; d<=31; d++){
          const opt = document.createElement('option');
          opt.value = String(d).padStart(2,'0');
          opt.textContent = d;
          $dobDay.appendChild(opt);
        }
      }
      function fillMonths(){
        if (!$dobMonth) return;
        const months = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
        $dobMonth.innerHTML = '<option value="">เดือน</option>';
        months.forEach((m,i)=>{
          const opt = document.createElement('option');
          opt.value = String(i+1).padStart(2,'0');
          opt.textContent = m;
          $dobMonth.appendChild(opt);
        });
      }
      function fillYearsBE(){
        if (!$dobYearB) return;
        const now = new Date();
        const thisBE = now.getFullYear()+543;
        const maxBE = thisBE - 18;
        const minBE = thisBE - 100;
        $dobYearB.innerHTML = '<option value="">พ.ศ.</option>';
        for (let y=maxBE; y>=minBE; y--){
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = y;
          $dobYearB.appendChild(opt);
        }
      }
      function updateDobIsoAndValidate(){
        if (!$dobDay) return true;
        const d = $dobDay.value, m = $dobMonth.value, yB = $dobYearB.value;
        $dobHint.hidden = true;
        if (!d || !m || !yB){ $dobIso.value=''; return false; }
        const yC = parseInt(yB,10) - 543, mm = parseInt(m,10), dd = parseInt(d,10);
        const dt = new Date(yC, mm-1, dd);
        const valid = (dt.getFullYear()===yC && dt.getMonth()===(mm-1) && dt.getDate()===dd);
        if (!valid){ $dobIso.value=''; $dobHint.hidden=false; return false; }
        const today=new Date();
        let age = today.getFullYear()-yC;
        const beforeBD = (today.getMonth()+1<mm) || (today.getMonth()+1===mm && today.getDate()<dd);
        if (beforeBD) age--;
        if (age<18){ $dobIso.value=''; $dobHint.textContent='ผู้สมัครต้องมีอายุอย่างน้อย 18 ปีบริบูรณ์'; $dobHint.hidden=false; return false; }
        $dobIso.value = `${yC}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
        return true;
      }
      fillDays(); fillMonths(); fillYearsBE();
      [$dobDay,$dobMonth,$dobYearB].forEach(el=> el && el.addEventListener('change', updateDobIsoAndValidate));

      // Thai address (เฉพาะชุดตามบัตร)
      initThaiAddress({
        province:    '#cid_province',
        district:    '#cid_district',
        subdistrict: '#cid_subdistrict',
        postcode:    '#postcode'
      });

      // ใส่ class .required ให้ field ที่มี required ข้างใน (ทำให้สไตล์ * โชว์อัตโนมัติ)
      document.querySelectorAll('.field').forEach(f => {
        if (f.querySelector('input[required], select[required], textarea[required]')) {
          f.classList.add('required');
        }
      });
    </script>

    <!-- เมนูผู้ใช้ -->
    <script>
      (() => {
        const menu = document.getElementById('userMenu');
        const btn  = document.getElementById('userArea');
        const chip = document.getElementById('userChip');
        const dd   = document.getElementById('userDropdown');
        if (!menu || !btn || !chip || !dd) return;

        // ค่าเริ่มต้นสำหรับผู้ที่ยังไม่ล็อกอิน
        dd.innerHTML = `
          <a href="/page/login.html" role="menuitem">เข้าสู่ระบบ</a>
          <a href="/page/add_member.html" role="menuitem">สมัครสมาชิก</a>
        `;

        fetch('/page/backend/me.php', { cache:'no-store' })
          .then(r => r.ok ? r.json() : {ok:false})
          .then(d => {
            if (d && d.ok) {
              const name = (d.user.display_name || d.user.name || '').trim();
              if (name) { chip.textContent = name; chip.hidden = false; }
              dd.innerHTML = `
                <a href="/page/profile.html" role="menuitem">บัญชีของฉัน</a>
                <a href="/page/my_order.html" role="menuitem">การซื้อของฉัน</a>
                <hr>
                <a href="/page/backend/logout.php" role="menuitem" class="logout">ออกจากระบบ</a>
              `;
            } else {
              chip.hidden = true; // guest
            }
          })
          .catch(() => { chip.hidden = true; });

        btn.addEventListener('click', e => {
          e.preventDefault();
          const open = menu.classList.toggle('open');
          btn.setAttribute('aria-expanded', open);
        });

        document.addEventListener('click', e => {
          if (!menu.contains(e.target)) { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
        });
        document.addEventListener('keydown', e => {
          if (e.key === 'Escape') { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); btn.blur(); }
        });
      })();
    </script>
  </body>
</html>
