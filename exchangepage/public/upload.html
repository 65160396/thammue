<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <base href="/exchangepage/public/">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thammue — อัปโหลดสินค้า</title>

    <!-- CSS -->
    <link rel="stylesheet" href="/exchangepage/css/instyle.css" />
    <link rel="stylesheet" href="/exchangepage/css/style.css" />
    <link rel="stylesheet" href="/exchangepage/css/exchange-upload.css" />
    <style>
      .visually-file{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
      .upload-box{display:grid;place-items:center;width:140px;height:140px;border:2px dashed #ccc;border-radius:12px;cursor:pointer;user-select:none}
      .upload-box .plus{font-size:42px;line-height:1}
      .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
      .thumbs img{width:100%;height:100px;object-fit:cover;border-radius:8px}
    </style>
  </head>
  <body>
    <ul class="top-nav">
      <li><a class="js-upload"
          href="/exchangepage/public/upload.html">อัพโหลดสินค้าแลกเปลี่ยน</a></li>
      <li><span class="top-divider">|</span></li>
      <li><a href="/thammue/page/main.html">ซื้อสินค้า</a></li>
      <li class="right"><a id="notiBtn" href="notifications.html">แจ้งเตือน
          <span id="notiBadge" hidden class="badge"></span></a></li>
      <li><span class="top-divider">|</span></li>
      <li><a href="#help">ช่วยเหลือ</a></li>
      <li><span class="top-divider">|</span></li>
      <li><a href="#lang">ไทย</a></li>
    </ul>

    <div class="header-wrapper">
      <div class="logo-container"><a href="/exchangepage/public/index.html"
          class="brand-text">THAMMUE</a></div>
      <div class="search-container">
        <div class="search-group">
          <input type="text" placeholder="ค้นหาสินค้า" />
          <button class="search-button" aria-label="ค้นหา"><img
              src="/exchangepage/img/Icon/search.png" alt="ค้นหา" /></button>
        </div>

        <div class="icon-buttons desktop-icons">
          <a class="action-button" href="/exchangepage/public/request.html"
            aria-label="คำขอแลกเปลี่ยน">
            <img src="/exchangepage/img/Icon/exchange.png" alt><span
              class="badge" id="reqBadge" hidden>0</span>
          </a>
          <a class="action-button" href="/exchangepage/public/fav.html"
            aria-label="รายการโปรด">
            <img src="/exchangepage/img/Icon/heart.png" alt><span class="badge"
              id="favBadge" hidden>0</span>
          </a>
          <a class="action-button" href="/exchangepage/public/chat.html"
            aria-label="แชท">
            <img src="/exchangepage/img/Icon/chat.png" alt><span class="badge"
              id="chatBadge" hidden>0</span>
          </a>

          <div class="user-menu" id="userMenu">
            <button class="user-area" id="userArea" aria-haspopup="true"
              aria-expanded="false">
              <img src="/exchangepage/img/Icon/user.png" alt="โปรไฟล์" />
              <span class="user-chip" id="userChip" hidden></span>
              <svg class="chev" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M5.5 7.5l4.5 4 4.5-4" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </button>
            <div class="user-dropdown" id="userDropdown" role="menu"></div>
          </div>
        </div>

        <button class="hamburger" aria-label="เปิดเมนู"
          aria-controls="mobileIcons" aria-expanded="false">
          <img src="/exchangepage/img/Icon/menu.png" alt aria-hidden="true">
        </button>
      </div>
    </div>

    <nav id="mobileIcons" class="icons-drawer" hidden>
      <button class="icons-drawer__close" aria-label="ปิดเมนู">✕</button>
      <a href="/exchangepage/public/request.html"><img
          src="../img/Icon/exchange.png" alt> คำขอแลกเปลี่ยน</a>
      <a href="/exchangepage/public/fav.html"><img src="../img/Icon/heart.png"
          alt> รายการโปรด</a>
      <a href="/exchangepage/public/chat.html"><img src="../img/Icon/chat.png"
          alt> แชท</a>

      <div class="user-menu" id="userMenu">
        <button class="user-area" id="userArea" aria-haspopup="true"
          aria-expanded="false">
          <img src="../img/Icon/user.png" alt="โปรไฟล์" />
          <span class="user-chip" id="userChip" hidden></span>
          <svg class="chev" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M5.5 7.5l4.5 4 4.5-4" fill="none" stroke="currentColor"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <div class="user-dropdown" id="userDropdown" role="menu"></div>
      </div>

      <a href="/page/profile.html"><img src="../img/Icon/user.png" alt>
        โปรไฟล์</a>
    </nav>
    <div class="icons-backdrop" hidden></div>

    <div class="category-buttons">
      <a href="category.html?category_id=1" class="category-button">แฮนเมด</a>
      <a href="category.html?category_id=2"
        class="category-button">ของประดิษฐ์</a>
      <a href="category.html?category_id=3"
        class="category-button">ของใช้ทั่วไป</a>
      <a href="category.html?category_id=4" class="category-button">เสื้อผ้า</a>
      <a href="category.html?category_id=5" class="category-button">หนังสือ</a>
      <a href="category.html?category_id=6" class="category-button">ของสะสม</a>
    </div>
    <!-- เนื้อหาหลัก -->
    <main class="container">
      <section class="card">
        <h2 class="page-title">อัปโหลดข้อมูลสินค้า</h2>

        <!-- Stepper -->
        <div class="stepper" aria-label="ขั้นตอนการกรอกฟอร์ม">
          <div class="stepper-line"><span class="stepper-fill"
              style="width:0%"></span></div>
          <div class="step" data-step="1"><span class="dot"></span><span
              class="label">ข้อมูลสินค้า</span></div>
          <div class="step" data-step="2"><span class="dot"></span><span
              class="label">สินค้าที่ต้องการ</span></div>
          <div class="step" data-step="3"><span class="dot"></span><span
              class="label">สถานที่นัดรับ</span></div>
        </div>

        <!-- เพิ่ม method/enctype เผื่อ fallback ส่งตรง -->
        <form id="exchangeForm" method="post" enctype="multipart/form-data"
          novalidate>
          <!-- STEP 1 -->
          <fieldset class="panel" data-step="1">
            <legend>ข้อมูลสินค้า</legend>

            <div class="field">
              <label for="title">* ชื่อสินค้า</label>
              <input id="title" name="title" type="text" required
                placeholder="เช่น เสื้อยืดมือสอง ไซส์ M" />
            </div>

            <div class="field">
              <label for="category_id">* หมวดหมู่</label>
              <select id="category_id" name="category_id" required>
                <option value selected disabled>— เลือกหมวดหมู่ —</option>
                <option value="1">แฮนเมด</option>
                <option value="2">ของประดิษฐ์</option>
                <option value="3">ของใช้ทั่วไป</option>
                <option value="4">เสื้อผ้า</option>
                <option value="5">หนังสือ</option>
                <option value="6">ของสะสม</option>
              </select>
            </div>

            <div class="field">
              <label for="description">รายละเอียดสินค้า</label>
              <textarea id="description" name="description" rows="3"
                placeholder="สภาพสินค้า / ปีที่ซื้อ / ตำหนิ"></textarea>
            </div>

            <div class="field">
              <label>รูปสินค้า *</label>
              <div class="upload">
                <input id="images" name="images[]" type="file" accept="image/*"
                  multiple class="visually-file" required>
                <label for="images" class="upload-box"
                  aria-label="เพิ่มรูปสินค้า"><span
                    class="plus">+</span></label>
                <div class="thumbs" id="thumbs1"></div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn primary next">ต่อไป</button>
            </div>
          </fieldset>

          <!-- STEP 2 -->
          <fieldset class="panel" data-step="2" hidden>
            <legend>สินค้าที่ต้องการ</legend>

            <div class="field">
              <label>หากไม่มีสินค้าที่ต้องการกดต่อไปได้เลย</label>
              <label for="want_title">ชื่อสินค้าที่ต้องการแลก</label>
              <input id="want_title" name="want_title" type="text"
                placeholder="เช่น เสื้อยืดลายการ์ตูน ไซส์ M" />
            </div>

            <div class="field">
              <label for="want_category_id">หมวดหมู่</label>
              <select id="want_category_id" name="want_category_id">
                <option value>— ไม่ระบุ —</option>
                <option value="1">แฮนเมด</option>
                <option value="2">ของประดิษฐ์</option>
                <option value="3">ของใช้ทั่วไป</option>
                <option value="4">เสื้อผ้า</option>
                <option value="5">หนังสือ</option>
                <option value="6">ของสะสม</option>
              </select>
            </div>

            <div class="field">
              <label for="want_note">รายละเอียดเพิ่มเติม</label>
              <textarea id="want_note" name="want_note" rows="3"
                placeholder="สี/สไตล์/เงื่อนไขการแลก"></textarea>
            </div>

            <div class="field">
              <label>รูปอ้างอิง (ถ้ามี)</label>
              <div class="upload">
                <input id="want_images" name="want_images[]" type="file"
                  accept="image/*" multiple hidden />
                <button type="button" class="upload-box" data-for="want_images"
                  aria-label="เพิ่มรูปอ้างอิง"><span
                    class="plus">+</span></button>
                <div class="thumbs" id="thumbs2"></div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost back">ย้อนกลับ</button>
              <button type="button" class="btn primary next">ต่อไป</button>
            </div>
          </fieldset>

          <!-- STEP 3 -->
          <fieldset class="panel" data-step="3" hidden>
            <legend>สถานที่นัดรับ</legend>

            <div class="grid-2">
              <div class="field">
                <label for="province">* จังหวัด</label>
                <select id="province" name="province" required>
                  <option value selected disabled>— เลือกจังหวัด —</option>
                </select>
              </div>
              <div class="field">
                <label for="district">* อำเภอ/เขต</label>
                <select id="district" name="district" required disabled>
                  <option value selected disabled>— เลือกอำเภอ/เขต —</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="subdistrict">* ตำบล/แขวง</label>
                <select id="subdistrict" name="subdistrict" required disabled>
                  <option value selected disabled>— เลือกตำบล/แขวง —</option>
                </select>
              </div>
              <div class="field">
                <label for="zipcode">รหัสไปรษณีย์</label>
                <input id="zipcode" name="zipcode" type="text"
                  placeholder="ใส่รหัสไปรษณีย์" />
              </div>
            </div>

            <div class="field">
              <label for="place_detail">รายละเอียดสถานที่</label>
              <input id="place_detail" name="place_detail" type="text"
                placeholder="บ้านเลขที่/หมู่/ซอย/ถนน" />
            </div>

            <div class="actions">
              <button type="button" class="btn ghost back">ย้อนกลับ</button>
              <button type="submit" id="forceSubmit"
                class="btn primary">ยืนยันการอัพโหลดสินค้า</button>
            </div>
          </fieldset>
        </form>
      </section>
    </main>

    <!-- JS -->
    <script src="/exchangepage/js/address.js"></script>
    <script>
      // ใช้ API พอร์ตเดียวกับเพื่อน
      window.API_BASE = '/exchangepage/api';

      (function () {
        const form   = document.getElementById('exchangeForm');
        const panels = [...document.querySelectorAll('.panel')];
        const fill   = document.querySelector('.stepper-fill');
        const steps  = [...document.querySelectorAll('.step')];
        const thumbs1 = document.getElementById('thumbs1');
        const input1  = document.getElementById('images');

        function setPanelRequired(panel, enable) {
          panel.querySelectorAll('[name][required]').forEach(el => {
            if (enable) el.setAttribute('required',''); else el.removeAttribute('required');
          });
        }

        let step = 1;
        function showStep(n) {
          step = Math.max(1, Math.min(3, n));
          panels.forEach(p => {
            const on = Number(p.dataset.step) === step;
            p.hidden = !on;
            setPanelRequired(p, on);
          });
          steps.forEach((s, i) => s.querySelector('.dot')?.classList.toggle('active', i < step));
          fill.style.width = ((step - 1) / 2) * 100 + '%';
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        showStep(1);

        document.querySelectorAll('.next').forEach(btn => btn.addEventListener('click', () => {
          const current = panels.find(p => !p.hidden);
          if (current && !current.checkValidity()) { current.reportValidity(); return; }
          showStep(step + 1);
        }));
        document.querySelectorAll('.back').forEach(btn => btn.addEventListener('click', () => showStep(step - 1)));

        input1?.addEventListener('change', () => {
          if (!input1.files) return;
          thumbs1.innerHTML = '';
          [...input1.files].forEach(file => {
            const url = URL.createObjectURL(file);
            const img = document.createElement('img');
            img.src = url; img.alt = file.name;
            thumbs1.appendChild(img);
          });
        });

        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const current = panels.find(p => !p.hidden);
          if (current && !current.checkValidity()) { current.reportValidity(); return; }

          const img = document.getElementById('images');
          if (!img || img.files.length === 0) { alert('กรุณาอัปโหลดรูปสินค้าอย่างน้อย 1 รูป'); showStep(1); return; }

          const fd = new FormData(form);
          try {
            // ✅ แก้ URL ให้ถูกต้อง (เอา /api ที่ซ้ำออก)
            const res = await fetch(`${window.API_BASE}/items/create.php`, {
              method: 'POST',
              body: fd,
              credentials: 'include',
              cache: 'no-store'
            });
            const data = await res.json().catch(() => null);

            if (!res.ok || !data?.ok) {
              alert('บันทึกล้มเหลว: ' + (data?.error || `${res.status} ${res.statusText}`));
              return;
            }

            // ใช้ success_url จาก API ถ้ามี (แน่นอนที่สุด)
            if (data.success_url) {
              location.href = data.success_url;
            } else {
              location.href = `success.html?id=${data.id || data.item_id}`;
            }
          } catch {
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
          }
        });
      })();
const burger = document.querySelector('.hamburger');
    const drawer = document.getElementById('mobileIcons');
    const closeBtn = document.querySelector('.icons-drawer__close');
    const backdrop = document.querySelector('.icons-backdrop');
    function openIcons(){ drawer.hidden=false; backdrop.hidden=false; requestAnimationFrame(()=>drawer.classList.add('open')); document.body.style.overflow='hidden'; }
    function closeIcons(){ drawer.classList.remove('open'); document.body.style.overflow=''; backdrop.hidden=true; setTimeout(()=>{ if(!drawer.classList.contains('open')) drawer.hidden=true; },250); }
    burger?.addEventListener('click', openIcons);
    closeBtn?.addEventListener('click', closeIcons);
    backdrop?.addEventListener('click', closeIcons);
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeIcons(); });

    // chip ชื่อผู้ใช้
    fetch('../api/me.php', { cache:'no-store', credentials:'include' })
      .then(r=>r.ok?r.json():{ok:false})
      .then(d=>{
        const chip = document.getElementById('userChip');
        const userArea = document.getElementById('userArea');
        if(!chip||!userArea) return;
        if(!d || !d.ok){ chip.hidden=true; userArea.href='/thammue/page/login.html'; return; }
        const name = (d.user && (d.user.display_name||d.user.name)||'').trim();
        if(name){ chip.textContent=name; chip.hidden=false; }
      })
      .catch(()=>{});
  </script>
    <script src="/exchangepage/public/js/auth.me.js"></script>
    <script type="module" src="../js/dot/index.page.js"></script>
    <script src="../js/header-noti.js"></script>
    <script src="../js/app-badges.js?v=2" defer></script>
    <script src="js/verification.modal.js" defer></script>
    <script src="/js/me.js"></script>
    <script src="/js/user-menu.js"></script>
  </body>
</html>
