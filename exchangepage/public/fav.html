<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <base href="/thammue/exchangepage/public/">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>รายการโปรด | THAMMUE</title>
  <link rel="stylesheet" href="../css/instyle.css" />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <ul class="top-nav">
    <li><a href="upload.html">อัพโหลดสินค้าแลกเปลี่ยน</a></li>
    <li><span class="top-divider">|</span></li>
    <li><a href="index.html">ซื้อสินค้า</a></li>
  </ul>

  <div class="header-wrapper">
    <div class="logo-container"><a href="index.html" class="brand-text">THAMMUE</a></div>
    <div class="search-container">
      <div class="search-group">
        <input type="text" placeholder="ค้นหาสินค้า" />
        <button class="search-button" aria-label="ค้นหา"><img src="../img/Icon/search.png" alt="ค้นหา" /></button>
      </div>
      <div class="icon-buttons">
        <a class="action-button" href="request.html"><img src="../img/Icon/exchange.png" alt=""></a>
        <a class="action-button" href="fav.html"><img src="../img/Icon/heart.png" alt=""></a>
        <a class="action-button" href="chat.html"><img src="../img/Icon/chat.png" alt=""></a>
        <a class="action-button" href="profile.html"><img src="../img/Icon/user.png" alt=""></a>
      </div>
    </div>
  </div>

  <div class="category-buttons">
    <a href="category.html?category_id=1" class="category-button">แฮนเมด</a>
    <a href="category.html?category_id=2" class="category-button">ของประดิษฐ์</a>
    <a href="category.html?category_id=3" class="category-button">ของใช้ทั่วไป</a>
    <a href="category.html?category_id=4" class="category-button">เสื้อผ้า</a>
    <a href="category.html?category_id=5" class="category-button">หนังสือ</a>
    <a href="category.html?category_id=6" class="category-button">ของสะสม</a>
  </div>

  <main class="section">
    <div class="container">
      <div class="section-head">
        <h2>รายการโปรดของฉัน</h2>
      </div>
      <div id="favGrid" class="grid grid-4"></div>
    </div>
  </main>

  <script>
    window.API_BASE = '/thammue/exchangepage/api';
    const grid = document.getElementById('favGrid');

    const toAbs = (p) => {
      if (!p) return '';
      if (p.startsWith('http') || p.startsWith('/')) return p;
      return '/thammue/exchangepage/' + p.replace(/^\/+/, '');
    };

    function render(items) {
      if (!items || !items.length) {
        grid.innerHTML = `<div class="card mini"><div class="thumb"></div><h4>ยังไม่มีรายการโปรด</h4><p class="muted">กดรูปหัวใจในหน้ารายการสินค้า</p></div>`;
        return;
      }
      grid.innerHTML = items.map(it => `
        <article class="card mini">
          <a href="detail.html?id=${it.id}&view=public" style="text-decoration:none;color:inherit">
            <div class="thumb">
              ${it.cover ? `<img src="${toAbs(it.cover)}" alt="" style="width:100%;height:120px;object-fit:cover;border-radius:8px 8px 0 0;">` : ''}
            </div>
            <h4>${it.title || ''}</h4>
            <p class="muted">หมวด: ${it.category_name || '-'}</p>
          </a>
          <div style="margin-top:6px;text-align:right">
            <button class="btn btn-sm" data-remove="${it.id}" style="background:#eee;border:1px solid #ddd">นำออก</button>
          </div>
        </article>
      `).join('');
    }

    async function loadFav() {
      const r = await fetch(`${window.API_BASE}/favorites/list.php`, { cache:'no-store', credentials:'include' });
      if (r.status === 401) {
        location.href = '/thammue/page/login.html?next=' + encodeURIComponent(location.pathname + location.search);
        return;
      }
      const d = await r.json().catch(() => ({ ok:false }));
      render(d.ok ? d.items : []);
    }

    grid.addEventListener('click', async (e) => {
      const id = e.target?.dataset?.remove;
      if (!id) return;
      const fd = new FormData();
      fd.append('item_id', id);
      fd.append('action', 'remove');
      await fetch(`${window.API_BASE}/favorites/toggle.php`, { method:'POST', body:fd, credentials:'include' });
      loadFav();
    });

    loadFav();
  </script>
</body>
</html>
