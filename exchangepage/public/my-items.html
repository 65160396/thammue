<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <base href="/thammue/exchangepage/public/">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>สินค้าของฉัน | THAMMUE</title>

  <link rel="stylesheet" href="../css/instyle.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="../css/cards.kebab.css" />
  <style>
    /* สไตล์เสริมสำหรับหน้านี้ */
    .page-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 14px 0 4px
    }

    .page-head h2 {
      margin: 0;
      font-size: 1.35rem
    }

    .toolbar {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .toolbar input[type="text"] {
      padding: 10px 12px;
      border: 1px solid var(--line, #e5e7eb);
      border-radius: 12px;
      min-width: 220px
    }

    .toolbar .btn {
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer
    }

    .empty {
      text-align: center;
      color: var(--muted, #6b7280);
      padding: 36px 12px
    }

    .grid.grid-4 {
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width: 1024px) {
      .grid.grid-4 {
        grid-template-columns: repeat(3, 1fr)
      }
    }

    @media (max-width: 720px) {
      .grid.grid-4 {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    @media (max-width: 480px) {
      .grid.grid-4 {
        grid-template-columns: 1fr
      }
    }

    /* การ์ด */
    .card {
      background: var(--card, #fff);
      border-radius: var(--radius, 14px);
      box-shadow: var(--shadow, 0 10px 24px rgba(0, 0, 0, .08));
      overflow: hidden
    }

    .card-img {
      aspect-ratio: 4/3;
      object-fit: cover;
      width: 100%;
      display: block;
      background: #f3f4f6
    }

    .card-body {
      padding: 12px
    }

    .card-title {
      margin: 0 0 6px;
      font-weight: 700;
      line-height: 1.35
    }

    .card-meta {
      font-size: .9rem;
      color: var(--muted, #6b7280);
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .card-foot {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-top: 1px solid var(--line, #e5e7eb);
      background: #fafafa
    }

    .pill {
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      font-size: .8rem
    }

    .kebab-wrap {
      position: relative
    }
  </style>
</head>

<body>
  <!-- แถบบนสุด -->
  <ul class="top-nav">
    <li><a href="upload.html">อัพโหลดสินค้าแลกเปลี่ยน</a></li>
    <li><span class="top-divider">|</span></li>
    <li><a href="/thammue/page/main.html">ซื้อสินค้า</a></li>
    <li class="right">
      <a id="notiBtn" href="notifications.html">
        แจ้งเตือน <span id="notiBadge" hidden class="badge"></span>
      </a>
    </li>
    <li><span class="top-divider">|</span></li>
    <li><a href="#help">ช่วยเหลือ</a></li>
    <li><span class="top-divider">|</span></li>
    <li><a href="#lang">ไทย</a></li>
  </ul>

  <!-- Header หลัก -->
 <div class="header-wrapper">
    <div class="logo-container">
      <a href="index.html" class="brand-text">THAMMUE</a>
    </div>

    <div class="search-container">
      <div class="search-group">
        <input type="text" placeholder="ค้นหาสินค้า" />
        <button class="search-button" aria-label="ค้นหา">
          <img src="../img/Icon/search.png" alt="ค้นหา" />
        </button>
      </div>

      <div class="icon-buttons desktop-icons">
        <a class="action-button" href="request.html" aria-label="คำขอแลกเปลี่ยน">
          <img src="../img/Icon/exchange.png" alt="">
          <span class="badge" id="reqBadge" hidden>0</span>
        </a>
        <a class="action-button" href="fav.html" aria-label="รายการโปรด">
          <img src="../img/Icon/heart.png" alt="">
          <span class="badge" id="favBadge" hidden>0</span>
        </a>
        <a class="action-button" href="chat.html" aria-label="แชท">
          <img src="../img/Icon/chat.png" alt="">
          <span class="badge" id="chatBadge" hidden>0</span>
        </a>

        <div class="user-menu" id="userMenu">
          <button class="user-area" id="userArea" aria-haspopup="true" aria-expanded="false">
            <img src="../img/Icon/user.png" alt="โปรไฟล์" />
            <span class="user-chip" id="userChip" hidden></span>
            <svg class="chev" viewBox="0 0 20 20" aria-hidden="true">
              <path d="M5.5 7.5l4.5 4 4.5-4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="user-dropdown" id="userDropdown" role="menu"></div>
        </div>
      </div>

      <button class="hamburger" aria-label="เปิดเมนู" aria-controls="mobileIcons" aria-expanded="false">
        <img src="../img/Icon/menu.png" alt="" aria-hidden="true">
      </button>
    </div>
  </div>

  <!-- เมนูมือถือ + หมวดหมู่ -->
  <nav id="mobileIcons" class="icons-drawer" hidden>
    <button class="icons-drawer__close" aria-label="ปิดเมนู">✕</button>
    <a href="request.html"><img src="../img/Icon/exchange.png" alt=""> คำขอแลกเปลี่ยน</a>
    <a href="fav.html"><img src="../img/Icon/heart.png" alt=""> รายการโปรด</a>
    <a href="chat.html"><img src="../img/Icon/chat.png" alt=""> แชท</a>
    <a href="profile.html"><img src="../img/Icon/user.png" alt=""> โปรไฟล์</a>
  </nav>
  <div class="icons-backdrop" hidden></div>

  <div class="category-buttons">
    <a href="category.html?category_id=1" class="category-button">แฮนเมด</a>
    <a href="category.html?category_id=2" class="category-button">ของประดิษฐ์</a>
    <a href="category.html?category_id=3" class="category-button">ของใช้ทั่วไป</a>
    <a href="category.html?category_id=4" class="category-button">เสื้อผ้า</a>
    <a href="category.html?category_id=5" class="category-button">หนังสือ</a>
    <a href="category.html?category_id=6" class="category-button">ของสะสม</a>
  </div>

    <main class="section">
    <div class="container">
      <div class="page-head">
        <h2>สินค้าของฉัน</h2>
        <div class="toolbar">
          <input id="q2" type="text" placeholder="กรองชื่อสินค้า..." />
          <button class="btn" id="btnClear">ล้างคำค้น</button>
          <a class="btn primary" href="upload.html">+ เพิ่มสินค้า</a>
        </div>
      </div>

      <div id="grid" class="grid grid-4"></div>
      <div id="empty" class="empty" style="display:none">ยังไม่มีสินค้า ลองกด “เพิ่มสินค้า” ด้านบนขวา</div>

      <div class="pager" style="display:flex;gap:8px;justify-content:center;margin:18px 0">
        <button class="btn" id="prevBtn">ก่อนหน้า</button>
        <span id="pageInfo" style="align-self:center"></span>
        <button class="btn" id="nextBtn">ถัดไป</button>
      </div>
    </div>
  </main>

  <script type="module">
    // ปรับ import ให้ชี้ไฟล์ใน exchangepage
    import { Kebab } from '../js/cards.kebab.js';

    const API_BASE = '/thammue/exchangepage/api';
    const state = { page: 1, per_page: 12, total: 0, q: '' };

    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const pageInfo = document.getElementById('pageInfo');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const q2 = document.getElementById('q2');
    const btnClear = document.getElementById('btnClear');

    // คอนโทรลค้นหา (มีจริงในหน้า)
    q2.addEventListener('input', (e) => {
      state.q = e.target.value.trim();
      state.page = 1; load();
    });
    btnClear.addEventListener('click', () => {
      q2.value = '';
      state.q = '';
      state.page = 1; load();
    });

    prevBtn.addEventListener('click', () => { if (state.page > 1) { state.page--; load(); } });
    nextBtn.addEventListener('click', () => {
      const maxPage = Math.ceil(state.total / state.per_page) || 1;
      if (state.page < maxPage) { state.page++; load(); }
    });

    // เทมเพลตการ์ด (เมนู 3 จุดให้ตรงกับ cards.kebab.js: ใช้ .card-kebab__menu + hidden)
    function cardHtml(it) {
      const img = it.cover || (it.images && it.images[0]) || '../img/placeholder.png';
      const href = `detail.html?id=${encodeURIComponent(it.id)}&view=owner`;
      const kebabId = `kebab-${it.id}`;
      const statusPill = it.status ? `<span class="pill">${it.status}</span>` : '';
      return `
        <article class="card" data-id="${it.id}">
          <a href="${href}" aria-label="${it.title}">
            <img class="card-img" src="${img}" alt="${it.title || 'รูปสินค้า'}" loading="lazy" />
          </a>
          <div class="card-body">
            <h3 class="card-title">${it.title || ''}</h3>
            <div class="card-meta">
              <span>หมวด: ${it.category_name || it.category || '-'}</span>
              <span>จังหวัด: ${it.province || '-'}</span>
            </div>
          </div>
          <div class="card-foot">
            ${statusPill}
            <div class="kebab-wrap card-kebab">
              <button class="card-kebab__btn"
                      aria-haspopup="menu"
                      aria-controls="${kebabId}"
                      aria-expanded="false">⋮</button>
              <div class="card-kebab__menu" id="${kebabId}" role="menu" hidden>
                <button class="card-kebab__item" role="menuitem" data-action="view" data-id="${it.id}">👁️ ดู</button>
                <button class="card-kebab__item" role="menuitem" data-action="edit" data-id="${it.id}">✏️ แก้ไข</button>
                <button class="card-kebab__item card-kebab__item--danger" role="menuitem" data-action="delete" data-id="${it.id}">🗑️ ลบ</button>
              </div>
            </div>
          </div>
        </article>
      `;
    }

    // โหลดข้อมูลจาก API
    async function load() {
      const url = `${API_BASE}/items/my.php?page=${state.page}&per_page=${state.per_page}&q=${encodeURIComponent(state.q)}`;
      let res, bodyText = '';
      try {
        res = await fetch(url, { credentials: 'include' });
        bodyText = await res.text();
      } catch (e) {
        console.error('MY_API -> network error', e);
        grid.innerHTML = '';
        empty.style.display = 'block';
        empty.textContent = 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้';
        pageInfo.textContent = '';
        return;
      }

      // log สถานะให้เห็นใน Console
      console.log('MY_API status:', res.status, res.statusText);
      console.log('MY_API body:', bodyText);

      // โชว์สถานะคร่าว ๆ บนหน้า
      empty.style.display = 'block';
      empty.textContent = `API: ${res.status} ${res.statusText}`;

      if (res.status === 401) {
        grid.innerHTML = '';
        empty.textContent = 'กรุณาเข้าสู่ระบบก่อนใช้งานหน้านี้ (401)';
        pageInfo.textContent = '';
        return;
      }

      if (!res.ok) {
        grid.innerHTML = '';
        empty.textContent = `เกิดข้อผิดพลาด (${res.status})`;
        pageInfo.textContent = '';
        return;
      }

      let data;
      try {
        data = JSON.parse(bodyText);
      } catch (e) {
        console.error('JSON parse error:', e);
        empty.textContent = 'รูปแบบข้อมูลจากเซิร์ฟเวอร์ไม่ถูกต้อง';
        return;
      }

      state.total = data.total || 0;
      const list = data.items || [];

      grid.innerHTML = list.map(cardHtml).join('');
      empty.style.display = list.length ? 'none' : 'block';
      empty.textContent = 'ยังไม่มีสินค้า ลองกด “เพิ่มสินค้า” ด้านบนขวา';

      const maxPage = Math.ceil(state.total / state.per_page) || 1;
      pageInfo.textContent = `หน้า ${state.page} / ${maxPage}`;

      Kebab.bind(grid);
    }


    load();
  </script>

  <script src="../js/app-badges.js?v=2" defer></script>
  <script src="../js/header-noti.js"></script>
</body>
</html>