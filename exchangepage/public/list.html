<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <base href="/thammue/exchangepage/public/">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thammue</title>
    <link rel="stylesheet" href="../css/instyle.css" />
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/cards.kebab.css" />
</head>

<body>

    <!-- ‡πÅ‡∏ñ‡∏ö‡∏ö‡∏ô‡∏™‡∏∏‡∏î (UI ‡πÄ‡∏î‡∏¥‡∏°) -->
    <ul class="top-nav">
        <li><a href="../public/upload.html">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</a></li>
        <li><span class="top-divider">|</span></li>
        <li><a href="../page/main.html">‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a></li>

        <li class="right"><a href="#notification">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</a></li>
        <li><span class="top-divider">|</span></li>
        <li><a href="#help">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</a></li>
        <li><span class="top-divider">|</span></li>
        <li><a href="#lang">‡πÑ‡∏ó‡∏¢</a></li>
    </ul>

    <!-- Header ‡∏´‡∏•‡∏±‡∏Å -->
    <div class="header-wrapper">
        <div class="logo-container">
            <a href="../public/index.html" class="brand-text">THAMMUE</a>
        </div>

        <div class="search-container">
            <div class="search-group">
                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" />
                <button class="search-button" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">
                    <img src="../img/Icon/search.png" alt="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" />
                </button>
            </div>

            <div class="icon-buttons desktop-icons">
                <a class="action-button" href="../public/request.html" aria-label="‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô">
                    <img src="../img/Icon/exchange.png" alt="">
                </a>
                <a class="action-button" href="../public/fav.html" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î">
                    <img src="../img/Icon/heart.png" alt="">
                </a>
                <a class="action-button" href="../public/chat.html" aria-label="‡πÅ‡∏ä‡∏ó">
                    <img src="../img/Icon/chat.png" alt="">
                </a>

                <div class="user-menu" id="userMenu">
                    <button class="user-area" id="userArea" aria-haspopup="true" aria-expanded="false">
                        <img src="../img/Icon/user.png" alt="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå" />
                        <span class="user-chip" id="userChip" hidden></span>
                        <svg class="chev" viewBox="0 0 20 20" aria-hidden="true">
                            <path d="M5.5 7.5l4.5 4 4.5-4" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="user-dropdown" id="userDropdown" role="menu"></div>
                </div>
            </div>

            <button class="hamburger" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π" aria-controls="mobileIcons" aria-expanded="false">
                <img src="../img/Icon/menu.png" alt="" aria-hidden="true">
            </button>
        </div>
    </div>

    <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ + ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà -->
    <nav id="mobileIcons" class="icons-drawer" hidden>
        <button class="icons-drawer__close" aria-label="‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π">‚úï</button>
        <a href="../public/request.html"><img src="../img/Icon/exchange.png" alt=""> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</a>
        <a href="../public/fav.html"><img src="../img/Icon/heart.png" alt=""> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î</a>
        <a href="../public/chat.html"><img src="../img/Icon/chat.png" alt=""> ‡πÅ‡∏ä‡∏ó</a>
        <a href="profile.html"><img src="../img/Icon/user.png" alt=""> ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
    </nav>
    <div class="icons-backdrop" hidden></div>

    <div class="category-buttons">
        <a href="../public/category.html?category_id=1" class="category-button">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</a>
        <a href="../public/category.html?category_id=2" class="category-button">‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏ö‡πâ‡∏≤‡∏ô</a>
        <a href="../public/category.html?category_id=3" class="category-button">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏î‡πá‡∏Å</a>
        <a href="../public/category.html?category_id=4" class="category-button">‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤</a>
        <a href="../public/category.html?category_id=5" class="category-button">‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</a>
        <a href="../public/category.html?category_id=6" class="category-button">‡∏Ç‡∏≠‡∏á‡∏™‡∏∞‡∏™‡∏°</a>
    </div>
    <!-- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡πÉ‡∏ô list.html -->
    <main class="section">
        <div class="container">
            <div class="section-head">
                <h2 id="listTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            </div>
            <div id="listGrid" class="grid grid-4"></div>
            <div class="center mt-16">
                <button id="loadMore" class="btn" hidden>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = '/thammue/exchangepage/api';

        function getQS() {
            const u = new URL(location.href);
            return {
                interest: u.searchParams.get('interest'),
                category_id: u.searchParams.get('category_id'),
                q: u.searchParams.get('q'),
            };
        }

        function cardHtml(it) {
            const img = it.cover || (it.images && it.images[0]) || '../img/placeholder.png';
            const title = it.title || '';
            const id = it.id;
            const province = it.province || '';
            const catName = it.category_name || it.category || '';
            const href = `detail.html?id=${encodeURIComponent(id)}&view=public`;
            const isOwner = it.is_owner === true;

            const menuHtml = isOwner
                ? `<button class="card-kebab__item" role="menuitem" data-action="edit" data-id="${id}">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
           <button class="card-kebab__item card-kebab__item--danger" role="menuitem" data-action="delete" data-id="${id}">üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>`
                : `<button class="card-kebab__item" role="menuitem" data-action="report" data-id="${id}">üö© Report</button>`;

            return `
      <article class="card" data-card-id="${id}">
        <a class="stretched-link" href="${href}" aria-label="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${title}"></a>
        <div class="card-kebab" data-id="${id}">
          <button class="card-kebab__btn" aria-haspopup="menu" aria-expanded="false" aria-controls="menu-${id}" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
          </button>
          <div class="card-kebab__menu" id="menu-${id}" role="menu" hidden>
            ${menuHtml}
          </div>
        </div>
        <div class="thumb">${img ? `<img src="${img}" alt="" style="width:100%;height:180px;object-fit:cover;border-radius:12px 12px 0 0;">` : ''}</div>
        <div class="card-body">
          <h3>${title}</h3>
          <p class="muted">‡∏´‡∏°‡∏ß‡∏î: ${catName || '-'} ${province ? ' ¬∑ ' + province : ''}</p>
          <a class="btn btn-sm" href="${href}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
        </div>
      </article>`;
        }

        let LIMIT = 24;
        let loaded = 0;
        let isLoading = false;
        let lastBatchCount = 0;

        function buildQuery(params) {
            const sp = new URLSearchParams();
            sp.set('limit', LIMIT);
            if (params.interest) sp.set('interest', params.interest);
            if (params.category_id) sp.set('category_id', params.category_id);
            if (params.q) sp.set('q', params.q);
            if (loaded > 0) sp.set('offset', loaded);
            return `?${sp.toString()}`;
        }

        async function fetchAndRender(append = false) {
            if (isLoading) return;
            isLoading = true;

            const host = document.getElementById('listGrid');
            const btn = document.getElementById('loadMore');
            const qs = getQS();

            document.getElementById('listTitle').textContent =
                qs.interest ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì' :
                    qs.category_id ? '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';

            try {
                const res = await fetch(`${API_BASE}/items/list.php${buildQuery(qs)}`, { cache: 'no-store' });
                const data = await res.json();

                if (data?.ok && Array.isArray(data.items) && data.items.length) {
                    const html = data.items.map(cardHtml).join('');
                    host.innerHTML = append ? (host.innerHTML + html) : html;

                    lastBatchCount = data.items.length;
                    loaded += data.items.length;
                    btn.hidden = !(lastBatchCount === LIMIT);
                } else {
                    if (!append) host.innerHTML = '<p class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ</p>';
                    btn.hidden = true;
                }
            } catch (e) {
                if (!append) host.innerHTML = '<p class="muted">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
                btn.hidden = true;
            } finally {
                isLoading = false;
            }
        }

        fetchAndRender(false);
        document.getElementById('loadMore').addEventListener('click', () => fetchAndRender(true));
    </script>

    <script type="module" src="../js/dot/list.page.js"></script>
</body>

</html>