<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>สมัครสมาชิก - กรอกข้อมูล</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="stylesheet" href="../css/auth.css" />
  </head>

  <body class="auth">
    <!-- แถบบนสุด -->
    <ul class="top-nav">
      <li class="right"><a href="#help">ช่วยเหลือ</a></li>
      <li><span class="top-divider">|</span></li>
      <li><a href="#lang">ไทย</a></li>
    </ul>

    <div class="header-wrapper">
      <div class="logo-container">
        <a href="/page/index.html" class="brand-link"
          aria-label="กลับหน้าแรก THAMMUE">
          <span class="brand-text">THAMMUE</span>
        </a>
      </div>
    </div>

    <div class="auth-page">
      <!-- Stepper: 2 ขั้น -->
      <div class="auth-steps" aria-hidden="true">
        <span class="auth-dot is-active"></span><span
          class="auth-line"></span>
        <span class="auth-dot"></span>
      </div>
      <div class="auth-step-labels">
        <span class="is-active">กรอกข้อมูล</span>
        <span>สมัครสมาชิกเสร็จสิ้น</span>
      </div>

      <!-- ฟอร์ม -->
      <form class="auth-form" id="signupForm" action="./backend/register.php"
        method="post" novalidate>
        <label class="auth-label" for="email"><span
            class="auth-req">*</span>อีเมล</label>
        <input class="auth-input" id="email" name="email" type="email" required>
        <small id="emailMsg" class="auth-field-msg"></small>

        <label class="auth-label" for="password">
          <span class="auth-req">*</span>รหัสผ่าน
          <span class="auth-hint"
            style="display:inline;margin-left:6px;">อย่างน้อย 8 ตัวอักษร</span>
        </label>
        <input class="auth-input" id="password" name="password" type="password"
          minlength="8" required>

        <label class="auth-label" for="confirm"><span
            class="auth-req">*</span>ยืนยันรหัสผ่าน</label>
        <input class="auth-input" id="confirm" name="confirm" type="password"
          minlength="8" required>

        <label class="auth-label" for="display"><span
            class="auth-req">*</span>ชื่อผู้ใช้</label>
        <input class="auth-input" id="display" name="display" type="text"
          required>

        <button class="auth-btn" type="submit" id="submitBtn">ถัดไป</button>
      </form>
    </div>

    <script>
    // ===== ตรวจอีเมลซ้ำแบบทันที =====
    const emailInput = document.getElementById('email');
    const emailMsg   = document.getElementById('emailMsg');
    const submitBtn  = document.getElementById('submitBtn');
    let debounceTimer;

    emailInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(checkEmail, 400); });
    emailInput.addEventListener('blur', checkEmail);

    async function checkEmail(){
      const val = emailInput.value.trim();
      // ถ้ายังไม่ใช่รูปแบบอีเมลที่ถูกต้อง ไม่ต้องเช็ก
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)){
        emailInput.classList.remove('is-invalid','is-valid');
        emailMsg.textContent = '';
        submitBtn.disabled = false;
        return;
      }
      try{
        const res  = await fetch('./backend/check_email.php', {
          method: 'POST',
          headers: {'Content-Type':'application/x-www-form-urlencoded'},
          body: new URLSearchParams({email: val})
        });
        const data = await res.json();
        if(data.ok && data.taken){
          emailInput.classList.add('is-invalid');
          emailInput.classList.remove('is-valid');
          emailMsg.textContent = 'อีเมลนี้ถูกใช้งานแล้ว';
          emailMsg.className = 'auth-field-msg is-error';
          submitBtn.disabled = true;
        }else if(data.ok){
          emailInput.classList.remove('is-invalid');
          emailInput.classList.add('is-valid');
          emailMsg.textContent = 'อีเมลนี้สามารถใช้งานได้';
          emailMsg.className = 'auth-field-msg is-success';
          submitBtn.disabled = false;
        }else{
          emailInput.classList.remove('is-valid','is-invalid');
          emailMsg.textContent = '';
          submitBtn.disabled = false;
        }
      }catch(err){
        console.error(err);
        submitBtn.disabled = false; // อย่าล็อกผู้ใช้ในกรณี error ฝั่งเซิร์ฟเวอร์
      }
    }

    // ===== ตรวจความถูกต้องก่อน submit =====
    const form = document.getElementById('signupForm');
    form.addEventListener('submit', (e) => {
      const email = emailInput.value.trim();
      const p     = document.getElementById('password').value;
      const c     = document.getElementById('confirm').value;
      const d     = document.getElementById('display').value.trim();

      if (submitBtn.disabled) { e.preventDefault(); return; }
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { e.preventDefault(); alert('กรุณากรอกอีเมลให้ถูกต้อง'); return; }
      if (p.length < 8) { e.preventDefault(); alert('รหัสผ่านต้องอย่างน้อย 8 ตัวอักษร'); return; }
      if (p !== c) { e.preventDefault(); alert('รหัสผ่านและยืนยันไม่ตรงกัน'); return; }
      if (!d) { e.preventDefault(); alert('กรุณากรอกชื่อผู้ใช้'); return; }
    });
  </script>
  </body>
</html>
