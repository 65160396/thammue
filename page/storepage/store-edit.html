<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Thammue – แก้ไขข้อมูลร้านค้า</title>
        <link rel="stylesheet" href="/css/style.css" />
        <link rel="stylesheet" href="/css/open-shop.css" />
    </head>
    <body class="open-shop">
        <div class="wizard-page">
            <div class="wizard-card">
                <h2 class="form-section">แก้ไขข้อมูลร้านค้า</h2>

                <form id="editForm">
                    <input type="hidden" name="shop_id" id="shopId" />

                    <div class="field">
                        <label for="fShopName">ชื่อร้าน</label>
                        <input type="text" name="shop_name" id="fShopName"
                            required />
                    </div>

                    <div class="field">
                        <label for="fEmail">อีเมล</label>
                        <input type="email" name="email" id="fEmail" required />
                    </div>

                    <div class="field">
                        <label for="fPhone">เบอร์โทร</label>
                        <input type="tel" name="phone" id="fPhone"
                            maxlength="20" />
                    </div>

                    <div class="field">
                        <label for="fAddr">ที่รับของ</label>
                        <textarea name="pickup_addr" id="fAddr"
                            rows="3"></textarea>
                    </div>

                    <div style="margin-top:16px; display:flex; gap:12px;">
                        <button class="btn primary"
                            type="submit">บันทึก</button>
                        <a class="btn" id="btnCancel">ยกเลิก</a>
                    </div>
                </form>

            </div>
        </div>

        <script>
    const url = new URL(location.href);
    const qid = url.searchParams.get('id');

    async function preload() {
      const res  = await fetch('/page/backend/productsforsale/get_shop.php', { credentials: 'include' });
      const data = await res.json();
      const s    = data.shop || {};

      const id = s.id || qid || '';
      document.getElementById('shopId').value = id;

      fShopName.value = s.shop_name   || '';
      fEmail.value    = s.email       || '';
      fPhone.value    = s.phone       || '';
      fAddr.value     = s.pickup_addr || '';
      // ไม่มี province แล้ว
    }

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(editForm);

      // ให้เบอร์เหลือตัวเลข
      const phone = (fd.get('phone') || '').toString().replace(/\D+/g, '');
      fd.set('phone', phone);

      try {
        // ✅ เปลี่ยน path ให้ตรงกับที่ไฟล์คุณอยู่จริง
        const res = await fetch('/page/storepage/update_shop.php', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });

        // กันกรณีเซิร์ฟเวอร์ตอบเป็น html หรือ error
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { throw new Error('เซิร์ฟเวอร์ตอบกลับไม่ใช่ JSON: ' + text.slice(0,120)); }

        if (!res.ok || !data.ok) {
          throw new Error((data && data.error) || 'บันทึกไม่สำเร็จ');
        }

        alert('บันทึกเรียบร้อย');
        location.href = `/page/storepage/store-info.html?shop_id=${encodeURIComponent(fd.get('shop_id'))}`;
      } catch (err) {
        alert('บันทึกไม่สำเร็จ: ' + (err.message || err));
        console.error(err);
      }
    });

    btnCancel.addEventListener('click', () => history.back());
    preload();
  </script>
    </body>
</html>
