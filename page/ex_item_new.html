<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>อัปโหลดสินค้า | THAMMUE</title>

    <!-- สไตล์หลักของเว็บ -->
    <link rel="stylesheet" href="/css/ex.exchange.css">
    <!-- สไตล์เฉพาะฟอร์มอัปโหลด -->
    <link rel="stylesheet" href="/css/exuplode.css">
    <!-- สไตล์ Header -->
    <link rel="stylesheet" href="/css/ex.header.css">
  </head>
  <body>
    <!-- Header/Topbar/Category: include ทีเดียวทุกหน้า -->
    <div data-include="/page/partials/ex_header.html"></div>
    <main class="upx">
      <section class="upx-card">
        <h2 class="page-title">อัปโหลดข้อมูลสินค้า</h2>

        <!-- Stepper -->
        <div class="stepper" aria-label="ขั้นตอน">
          <div class="stepper-line">
            <span class="stepper-fill" style="width:0%"></span>
          </div>
          <div class="step" data-step="1">
            <span class="dot active"></span><span
              class="label">ข้อมูลสินค้า</span>
          </div>
          <div class="step" data-step="2">
            <span class="dot"></span><span class="label">สินค้าที่ต้องการ</span>
          </div>
          <div class="step" data-step="3">
            <span class="dot"></span><span class="label">สถานที่นัดรับ</span>
          </div>
        </div>

        <!-- ฟอร์ม -->
        <form id="exchangeForm" novalidate>
          <!-- STEP 1 -->
          <fieldset class="panel" data-step="1">
            <div class="field">
              <label for="title">* ชื่อสินค้า</label>
              <input id="title" name="title" type="text"
                placeholder="เช่น เสื้อยืดมือสอง ไซส์ M" required>
            </div>

            <div class="field">
              <label for="category_id">* หมวดหมู่</label>
              <select id="category_id" name="category_id" required>
                <option value disabled selected>— เลือกหมวดหมู่ —</option>
                <option value="1">แฮนเมด</option>
                <option value="2">ของประดิษฐ์</option>
                <option value="3">ของใช้ทั่วไป</option>
                <option value="4">เสื้อผ้า</option>
                <option value="5">หนังสือ</option>
                <option value="6">ของสะสม</option>
              </select>
            </div>

            <div class="field">
              <label for="description">รายละเอียดสินค้า</label>
              <textarea id="description" name="description"
                placeholder="สภาพสินค้า / ปีที่ซื้อ / ตำหนิ"></textarea>
            </div>

            <div class="field">
              <label>รูปสินค้า *</label>
              <div class="upload">
                <input id="images" name="images[]" type="file" accept="image/*"
                  multiple class="visually-file" required>
                <label for="images" class="upload-box"
                  aria-label="เพิ่มรูปสินค้า">
                  <span class="plus">+</span>
                </label>
                <div class="thumbs" id="thumbs1"></div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn primary next">ต่อไป</button>
            </div>
          </fieldset>

          <!-- STEP 2 -->
          <fieldset class="panel" data-step="2" hidden>
            <legend>สินค้าที่ต้องการ</legend>

            <div class="field">
              <label>หากไม่มีสินค้าที่ต้องการกดต่อไปได้เลย</label>

              <label for="want_title">ชื่อสินค้าที่ต้องการแลก</label>
              <input id="want_title" name="want_title" type="text"
                placeholder="เช่น เสื้อยืดลายการ์ตูน ไซส์ M" />
            </div>

            <div class="field">
              <label for="want_category_id">หมวดหมู่</label>
              <select id="want_category_id" name="want_category_id">
                <option value>— ไม่ระบุ —</option>
                <option value="1">แฮนเมด</option>
                <option value="2">ของประดิษฐ์</option>
                <option value="3">ของใช้ทั่วไป</option>
                <option value="4">เสื้อผ้า</option>
                <option value="5">หนังสือ</option>
                <option value="6">ของสะสม</option>
              </select>
            </div>

            <div class="field">
              <label for="want_note">รายละเอียดเพิ่มเติม</label>
              <textarea id="want_note" name="want_note" rows="3"
                placeholder="สี/สไตล์/เงื่อนไขการแลก"></textarea>
            </div>

            <div class="field">
              <label>รูปอ้างอิง (ถ้ามี)</label>
              <div class="upload">
                <input id="want_images" name="want_images[]" type="file"
                  accept="image/*" multiple hidden />
                <button type="button" class="upload-box" data-for="want_images"
                  aria-label="เพิ่มรูปอ้างอิง"><span
                    class="plus">+</span></button>
                <div class="thumbs" id="thumbs2"></div>
              </div>
            </div>

            <div class="actions">
              <button type="button" class="btn ghost back">ย้อนกลับ</button>
              <button type="button" class="btn primary next">ต่อไป</button>
            </div>
          </fieldset>

          <!-- STEP 3 -->
          <fieldset class="panel" data-step="3" hidden>
            <legend>สถานที่นัดรับ</legend>

            <div class="grid-2">
              <div class="field">
                <label for="province">* จังหวัด</label>
                <select id="province" name="province" required>
                  <option value selected disabled>— เลือกจังหวัด —</option>
                </select>
              </div>
              <div class="field">
                <label for="district">* อำเภอ/เขต</label>
                <select id="district" name="district" required disabled>
                  <option value selected disabled>— เลือกอำเภอ/เขต —</option>
                </select>
              </div>
            </div>

            <div class="grid-2">
              <div class="field">
                <label for="subdistrict">* ตำบล/แขวง</label>
                <select id="subdistrict" name="subdistrict" required disabled>
                  <option value selected disabled>— เลือกตำบล/แขวง —</option>
                </select>
              </div>
              <div class="field">
                <label for="zipcode">รหัสไปรษณีย์</label>
                <input id="zipcode" name="zipcode" type="text"
                  placeholder="ระบบจะกรอกให้อัตโนมัติ" readonly>
                <!-- ถ้าต้องการให้แก้มือได้ ให้ลบ readonly ออก -->
              </div>
            </div>

            <div class="field">
              <label for="place_detail">รายละเอียดสถานที่</label>
              <input id="place_detail" name="place_detail" type="text"
                placeholder="บ้านเลขที่/หมู่/ซอย/ถนน">
            </div>

            <div class="actions">
              <button type="button" class="btn ghost back">ย้อนกลับ</button>
              <button type="submit" id="forceSubmit" class="btn primary">
                ยืนยันการอัพโหลดสินค้า
              </button>
            </div>
          </fieldset>
        </form>
      </section>
    </main>

    <!-- ===== Scripts ===== -->
    <script src="/js/ex.include.js"></script>
    <script src="/js/me.js"></script>
    <script src="/js/ex.header.js"></script>

    <!-- address loader (จังหวัด/อำเภอ/ตำบล) -->
    <script src="/js/address.js"></script>

    <!-- ฟังก์ชันฟอร์ม -->
    <script>
    // ===== ตั้งค่า BASE ให้เป็น /page/backend (ไม่ใช่ /exchangepage) =====
   const API_BASE   = '/page/backend';
const CREATE_URL = API_BASE + '/ex_item_create.php';  // ถ้าไฟล์คุณอยู่อีกโฟลเดอร์ ให้แก้ path นี้จุดเดียว

    (function () {
      const form      = document.getElementById('exchangeForm');
      const panels    = [...document.querySelectorAll('.panel')];
      const fill      = document.querySelector('.stepper-fill');
      const steps     = [...document.querySelectorAll('.step')];

      const thumbs1   = document.getElementById('thumbs1');
      const input1    = document.getElementById('images');
      const wantBtn   = document.querySelector('[data-for="want_images"]');
      const wantInput = document.getElementById('want_images');
      const thumbs2   = document.getElementById('thumbs2');

      function setPanelRequired(panel, enable) {
        panel.querySelectorAll('[name][required]').forEach(el => {
          if (enable) el.setAttribute('required',''); else el.removeAttribute('required');
        });
      }

      let step = 1;
      function showStep(n) {
        step = Math.max(1, Math.min(3, n));
        panels.forEach(p => {
          const on = Number(p.dataset.step) === step;
          p.hidden = !on;
          setPanelRequired(p, on);
        });
        steps.forEach((s, i) => s.querySelector('.dot')?.classList.toggle('active', i < step));
        fill.style.width = ((step - 1) / 2) * 100 + '%';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      showStep(1);

      document.querySelectorAll('.next').forEach(btn => btn.addEventListener('click', () => {
        const current = panels.find(p => !p.hidden);
        if (current && !current.checkValidity()) { current.reportValidity(); return; }
        showStep(step + 1);
      }));
      document.querySelectorAll('.back').forEach(btn => btn.addEventListener('click', () => showStep(step - 1)));

      // พรีวิวรูป step1
      input1?.addEventListener('change', () => {
        if (!input1.files) return;
        thumbs1.innerHTML = '';
        [...input1.files].forEach(file => {
          const url = URL.createObjectURL(file);
          const img = document.createElement('img');
          img.src = url; img.alt = file.name;
          thumbs1.appendChild(img);
        });
      });

      // พรีวิวรูป step2
      wantBtn?.addEventListener('click', () => wantInput?.click());
      wantInput?.addEventListener('change', () => {
        if (!wantInput.files) return;
        thumbs2.innerHTML = '';
        [...wantInput.files].forEach(file => {
          const url = URL.createObjectURL(file);
          const img = document.createElement('img');
          img.src = url; img.alt = file.name;
          thumbs2.appendChild(img);
        });
      });

      // ส่งข้อมูล
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const current = panels.find(p => !p.hidden);
        if (current && !current.checkValidity()) { current.reportValidity(); return; }

        const img = document.getElementById('images');
        if (!img || img.files.length === 0) { alert('กรุณาอัปโหลดรูปสินค้าอย่างน้อย 1 รูป'); showStep(1); return; }

        const fd = new FormData(form);
        try {
          const res  = await fetch(CREATE_URL, { method:'POST', body:fd, credentials:'include', cache:'no-store' });
          const data = await res.json().catch(() => null);

          if (!res.ok || !data?.ok) {
            alert('บันทึกล้มเหลว: ' + (data?.error || `${res.status} ${res.statusText}`));
            return;
          }

          if (data.success_url) {
            location.href = data.success_url;
          } else {
            location.href = `/page/ex_requests.html?created=1&id=${encodeURIComponent(data.id || data.item_id || '')}`;
          }
        } catch {
          alert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์');
        }
      });
    })();
  </script>
  </body>
</html>
