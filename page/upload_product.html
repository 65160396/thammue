<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Thammue – เปิดร้านค้า</title>
        <link rel="stylesheet" href="/css/style.css" />
        <link rel="stylesheet" href="/css/open-shop.css" />
        <style>
    .open-shop .field.required > label::before{content:"* ";color:#d0342c;font-weight:600;}
    .open-shop .field label:has(+ .dob-row select[required]){position:relative;padding-left:12px;}
    .open-shop .field label:has(+ .dob-row select[required])::before{content:"*";position:absolute;left:0;top:0;color:#d0342c;font-weight:600;}
  </style>
    </head>
    <body class="open-shop">

        <!-- topbar -->
        <ul class="top-nav">
            <li><a href="/page/upload_product.html">อัพโหลดสินค้า</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="/page/main.html">ซื้อสินค้า</a></li>
            <li class="right"><a href="#notification">แจ้งเตือน</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="#help">ช่วยเหลือ</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="#lang">ไทย</a></li>
        </ul>

        <!-- Header หลัก -->
        <div class="header-wrapper">
            <div class="logo-container">
                <a href="/page/main.html" class="brand-text">THAMMUE</a>
            </div>

            <div class="search-container">
                <div class="search-group">
                    <input type="text" placeholder="ค้นหาสินค้า" />
                    <button class="search-button" aria-label="ค้นหา">
                        <img src="/img/Icon/search.png" alt="ค้นหา" />
                    </button>
                </div>

                <div class="icon-buttons">
                    <button class="action-button"><img src="/img/Icon/heart.png"
                            alt="รายการโปรด" /></button>
                    <button class="action-button"><img
                            src="/img/Icon/shopping-cart.png"
                            alt="ตะกร้า" /></button>
                    <button class="action-button"><img src="/img/Icon/chat.png"
                            alt="แชท" /></button>

                    <!-- ▼ โปรไฟล์ + ชื่อ + เมนูดรอปดาวน์ -->
                    <div class="user-menu" id="userMenu">
                        <button class="user-area" id="userArea"
                            aria-haspopup="true" aria-expanded="false">
                            <img src="/img/Icon/user.png" alt="โปรไฟล์" />
                            <span class="user-chip" id="userChip" hidden></span>
                            <svg class="chev" viewBox="0 0 20 20"
                                aria-hidden="true">
                                <path d="M5.5 7.5l4.5 4 4.5-4" fill="none"
                                    stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </button>

                        <div class="user-dropdown" id="userDropdown"
                            role="menu">
                            <!-- JS จะเติมรายการให้ (guest: login/register, user: account/orders/logout) -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ดึงชื่อผู้ใช้จาก me.php และจัดการเมนูดรอปดาวน์ -->
        <script>
      //ดึงชื่อผู้ใช้ข้างไอคอนจาก me.php
      (function () {
        const chip = document.getElementById('userChip');
        const userArea = document.getElementById('userArea');
        if (!chip || !userArea) return;

        fetch('/page/backend/me.php', { cache: 'no-store' })
          .then(r => r.ok ? r.json() : { ok:false })
          .then(d => {
            if (!d || !d.ok) { // ไม่ล็อกอิน
              chip.hidden = true; //    ซ่อนชื่อ
              userArea.href = '/page/login.html';  // กดปุ่มโปรไฟล์แล้วพาไปหน้า login
              return;
            }
              //กรณี “ล็อกอินแล้ว”
            const name = (d.user && (d.user.display_name || d.user.name) || '').trim();
            if (name) { 
              chip.textContent = name; // เติมชื่อ
              chip.hidden = false; }  // โชว์ชื่อ
          })
          .catch(() => { chip.hidden = true; }); // มี error ก็ซ่อนชื่อไว้
      })();
    </script>

        <!---เมนูดรอปดาวน์ และควบคุมเปิด/ปิด---!-->
        <script>
(() => {
  const menu = document.getElementById('userMenu');
  const btn  = document.getElementById('userArea');
  const chip = document.getElementById('userChip');
  const dd   = document.getElementById('userDropdown');
  if (!menu || !btn || !chip || !dd) return;

  // ค่าเริ่มต้นสำหรับผู้ที่ยังไม่ล็อกอิน
  dd.innerHTML = `
    <a href="/page/login.html" role="menuitem">เข้าสู่ระบบ</a>
    <a href="/page/add_member.html" role="menuitem">สมัครสมาชิก</a>
  `;

  // ดึงชื่อผู้ใช้จาก PHP
  fetch('/page/backend/me.php', { cache:'no-store' })
    .then(r => r.ok ? r.json() : {ok:false})
    .then(d => {
      if (d && d.ok) {
        const name = (d.user.display_name || d.user.name || '').trim();
        if (name) { chip.textContent = name; chip.hidden = false; }
        dd.innerHTML = `
          <a href="/page/profile.html" role="menuitem">บัญชีของฉัน</a>
          <a href="/page/my_order.html" role="menuitem">การซื้อของฉัน</a>
          <hr>
          <a href="/page/backend/logout.php" role="menuitem" class="logout">ออกจากระบบ</a>
        `;
      } else {
        chip.hidden = true; // guest
      }
    })
    .catch(() => { chip.hidden = true; });

  // เปิด/ปิดด้วยคลิก (สำหรับมือถือ)
  btn.addEventListener('click', e => {
    e.preventDefault();
    const open = menu.classList.toggle('open');
    btn.setAttribute('aria-expanded', open);
  });

  // ปิดเมื่อคลิกข้างนอกหรือกด Esc
  document.addEventListener('click', e => {
    if (!menu.contains(e.target)) { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); btn.blur(); }
  });
})();
</script>

    </body>
</html>
