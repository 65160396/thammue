<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | THAMMUE</title>

    <link rel="stylesheet" href="/css/ex.exchange.css" />
    <link rel="stylesheet" href="/css/ex.header.css" />
    <style>
      body{ background:#f6f8fb; }
      .detail-wrap{max-width:1100px;margin:0 auto;padding:16px}
      .back-link{display:inline-block;margin:4px 0 10px;color:#111;text-decoration:none}
      .back-link:hover{text-decoration:underline}
      .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
      .photo-main{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff}
      .photo-main img{display:block;width:100%;height:auto}
      .thumbs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
      .thumb{width:94px;height:74px;border-radius:8px;overflow:hidden;border:2px solid transparent;cursor:pointer;background:#fff}
      .thumb img{width:100%;height:100%;object-fit:cover;display:block}
      .thumb.active{border-color:#0ea5e9}
      .box{background:#fff;border:1px solid #eee;border-radius:12px;padding:16px}
      .detail-title{font-size:1.5rem;font-weight:800;margin:0 0 6px}
      .chip{display:inline-block;background:#f1f5f9;color:#334155;border-radius:999px;padding:.25rem .5rem;font-size:.85rem;margin-right:6px}
      .muted{color:#64748b}
      .meta2{margin-top:6px}

      .btn{border:1px solid #cbd5e1;background:#fff;color:#0f172a;border-radius:10px;padding:10px 14px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px;font-weight:700}
      .btn-ghost{border:1px solid #cbd5e1;background:#fff;color:#0ea5e9}
      .btn-primary{background:#111827;color:#fff;border:none}
      .btn:focus{outline:3px solid rgba(14,165,233,.25);outline-offset:2px}
      .btn[disabled]{opacity:.5;pointer-events:none;cursor:not-allowed}
      .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
      .fav-row{margin:8px 0 10px}
      .flash{margin-top:10px;background:#e8f7ef;color:#14532d;border:1px solid #bbf7d0;padding:10px 12px;border-radius:10px;font-size:14px}
      #notfound .box{ text-align:center; font-weight:700 }

      .own-banner{
        margin-top:10px;background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0;
        border-radius:10px;padding:10px 12px;font-weight:700;
      }

      /* ===== Modal ===== */
      .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:40}
      .modal{position:fixed;inset:0;display:none;z-index:50;align-items:center;justify-content:center}
      .modal.open,.modal-backdrop.open{display:flex}
      .modal-card{width:min(720px,94vw);background:#fff;border-radius:14px;border:1px solid #e5e7eb;box-shadow:0 30px 80px rgba(0,0,0,.25)}
      .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eef1f5}
      .modal-title{font-weight:800}
      .modal-body{padding:12px 16px;max-height:70vh;overflow:auto}
      .modal-foot{padding:12px 16px;border-top:1px solid #eef1f5;display:flex;justify-content:flex-end;gap:8px}
      .x{background:transparent;border:0;font-size:20px;cursor:pointer}
      .my-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fill, minmax(220px,1fr))}
      .my-card{border:1px solid #eef1f5;border-radius:12px;overflow:hidden;background:#fff}
      .my-thumb{height:140px;background:#f3f4f6;background-size:cover;background-position:center}
      .my-body{padding:8px 10px}
      .radio-row{display:flex;align-items:center;gap:8px;margin-top:6px}
      .note-box{width:100%;min-height:74px;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
      .fav-on{border-color:#a58bff;background:#f6f0ff}
    </style>
  </head>
  <body>
    <div data-include="/page/partials/ex_header.html"></div>

    <main class="detail-wrap">
      <a href="/page/ex_index.html" class="back-link">‚üµ ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

      <div id="notfound" style="padding:24px;display:none">
        <div class="box">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</div>
      </div>

      <div id="detail" class="detail-grid" style="display:none">
        <div>
          <div class="photo-main" aria-label="‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
            <img id="mainImg" src alt="‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
          </div>
          <div class="thumbs" id="thumbs"></div>
        </div>

        <div>
          <div class="box">
            <h2 id="title" class="detail-title">‚Äî</h2>

            <div class="meta">
              <span class="chip" id="cat">‡∏´‡∏°‡∏ß‡∏î: -</span>
              <span class="chip" id="loc">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: -</span>
            </div>

            <div id="pickupLine" class="muted meta2" style="display:none"></div>

            <div class="fav-row">
              <button id="favBtn" class="btn btn-ghost" aria-pressed="false" title="‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î">
                <span id="favIcon" class="icon">ü§ç</span> <span id="favText">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î</span>
              </button>
            </div>

            <p id="desc" class="muted" style="white-space:pre-wrap"></p>

            <div class="actions">
              <a id="chatBtn" class="btn btn-ghost" href="#">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</a>
              <button id="openOffer" class="btn btn-primary" type="button">‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>

            <div id="ownBanner" class="own-banner" hidden>‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>

            <div id="flash" class="flash" role="status" aria-live="polite" hidden></div>
          </div>

          <div class="box muted" style="margin-top:12px">
            ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="ownerName">-</span> ¬∑ ‡∏£‡∏´‡∏±‡∏™‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: <span id="refCode">-</span>
          </div>
        </div>
      </div>
    </main>

    <!-- ===== Modal ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å ===== -->
    <div class="modal-backdrop" id="offerBackdrop" aria-hidden="true"></div>
    <div class="modal" id="offerModal" role="dialog" aria-modal="true" aria-labelledby="offerTitle">
      <div class="modal-card">
        <div class="modal-head">
          <div id="offerTitle" class="modal-title">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‚Äù ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏Å</div>
          <button class="x" id="offerClose" aria-label="‡∏õ‡∏¥‡∏î">‚úï</button>
        </div>
        <div class="modal-body">
          <div id="myItemsBox">
            <div class="muted" id="myItemsHint">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‚Ä¶</div>
            <div class="my-grid" id="myItemsGrid"></div>
          </div>
          <div style="margin-top:10px">
            <label class="muted" for="offerNote">‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡∏∂‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <textarea id="offerNote" class="note-box" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
          </div>
        </div>
        <div class="modal-foot">
          <button class="btn btn-primary" id="offerSubmit" type="button">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡∏Å</button>
        </div>
      </div>
    </div>

    <script src="/js/ex.include.js"></script>
    <script src="/js/me.js"></script>
    <script src="/js/ex.header.js"></script>

    <script>
(function(){
  const qs = new URLSearchParams(location.search);
  const itemId = qs.get('id');

  const API = {
    getItem     : id => `/page/backend/ex_item_get.php?id=${encodeURIComponent(id)}`,
    listMine    : `/page/backend/ex_list_my_items.php`,
    createReq   : `/page/backend/ex_request_create.php`,
    badge       : `/page/backend/ex_badge_counts.php`,
    favStatus   : id => `/page/backend/ex_favorite_status.php?item_id=${encodeURIComponent(id)}`,
    favToggle   : `/page/backend/ex_favorite_toggle.php`,
  };

  const $notfound   = document.getElementById('notfound');
  const $detail     = document.getElementById('detail');
  const $mainImg    = document.getElementById('mainImg');
  const $thumbs     = document.getElementById('thumbs');
  const $title      = document.getElementById('title');
  const $cat        = document.getElementById('cat');
  const $loc        = document.getElementById('loc');
  const $pickupLine = document.getElementById('pickupLine');
  const $desc       = document.getElementById('desc');
  const $owner      = document.getElementById('ownerName');
  const $ref        = document.getElementById('refCode');
  const $favBtn     = document.getElementById('favBtn');
  const $favIcon    = document.getElementById('favIcon');
  const $favText    = document.getElementById('favText');
  const $flash      = document.getElementById('flash');
  const $chatBtn    = document.getElementById('chatBtn');
  const $openOffer  = document.getElementById('openOffer');
  const $ownBanner  = document.getElementById('ownBanner');

  // modal
  const $mBackdrop  = document.getElementById('offerBackdrop');
  const $mModal     = document.getElementById('offerModal');
  const $mClose     = document.getElementById('offerClose');
  const $mGrid      = document.getElementById('myItemsGrid');
  const $mHint      = document.getElementById('myItemsHint');
  const $mNote      = document.getElementById('offerNote');
  const $mSubmit    = document.getElementById('offerSubmit');

  if (!itemId) { $notfound.style.display = ''; return; }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  fetch(API.getItem(itemId), { cache:'no-store', credentials:'include' })
    .then(async r => {
      const raw = await r.text();
      try {
        const d = JSON.parse(raw);
        if (!d.ok || !d.item) throw new Error(d.error || 'no item');
        const it = d.item;

        $detail.style.display = '';
        $title.textContent = it.title || '‚Äî';
        $cat.textContent   = `‡∏´‡∏°‡∏ß‡∏î: ${it.category_name || '-'}`;
        const area = [it.addr_province, it.addr_subdistrict].filter(Boolean).join(' ¬∑ ');
        $loc.textContent = `‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ${area || '-'}`;

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö
        const pickText = (it.place_detail || '').trim();
        $pickupLine.style.display = pickText ? '' : 'none';
        if (pickText) $pickupLine.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö: ${pickText}`;

        $desc.textContent  = it.description || '-';
        $owner.textContent = it.owner_name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
        $ref.textContent   = it.ref_code || `EX${String(it.id||'').padStart(6,'0')}`;

        const imgs = [];
        if (it.thumbnail_url) imgs.push(it.thumbnail_url);
        if (Array.isArray(it.images)) imgs.push(...it.images);
        const uniq = [...new Set(imgs.filter(Boolean))];
        if (uniq.length) {
          $mainImg.src = uniq[0];
          renderThumbs(uniq);
        }

        if (it.is_owner) {
          markOwnerMode();
        } else if (it.owner_id) {
          $chatBtn.href = `/page/ex_chat.html?to=${encodeURIComponent(it.owner_id)}&item=${encodeURIComponent(it.id)}`;
          // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
          initFavoriteState();
        }
      } catch(e) {
        console.error('getItem error:', e, 'raw=', raw);
        $notfound.style.display = '';
      }
    })
    .catch(() => { $notfound.style.display = ''; });

  async function initFavoriteState(){
    try{
      const r = await fetch(API.favStatus(itemId), {credentials:'include', cache:'no-store'});
      const d = await r.json();
      if(d.ok){ setFavState(!!d.is_favorite); }
    }catch(e){ console.warn('fav status', e); }
  }

  function renderThumbs(arr){
    $thumbs.innerHTML = '';
    arr.forEach((src,i)=>{
      const b = document.createElement('button');
      b.className = 'thumb' + (i===0 ? ' active':'' );
      b.type='button';
      b.onclick = () => {
        [...$thumbs.children].forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        $mainImg.src = src;
      };
      const im = document.createElement('img');
      im.src = src; im.alt='‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      b.appendChild(im);
      $thumbs.appendChild(b);
    });
  }

  function setFavState(on){
    $favBtn.classList.toggle('fav-on', on);
    $favBtn.setAttribute('aria-pressed', on ? 'true' : 'false');
    $favIcon.textContent = on ? 'üíú' : 'ü§ç';
    $favText.textContent = on ? '‡∏•‡∏ö‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡∏î' : '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î';
  }

  $favBtn.addEventListener('click', async () => {
    try{
      $favBtn.disabled = true;
      const r = await fetch(API.favToggle, {
        method:'POST',
        credentials:'include',
        headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
        body: new URLSearchParams({ item_id: itemId }).toString()
      });
      const d = await r.json().catch(()=>null);
      if (d?.ok) {
        setFavState(Boolean(d.is_favorite));
        flash(d.is_favorite ? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏•‡πâ‡∏ß');
      } else {
        flash(d?.error || '‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
      }
    }catch{
      flash('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', true);
    }finally{
      $favBtn.disabled = false;
    }
  });

  function markOwnerMode(){
    $ownBanner.hidden = false;
    $favBtn.setAttribute('disabled', 'true');
    $chatBtn.setAttribute('disabled', 'true'); $chatBtn.removeAttribute('href');
    $openOffer.setAttribute('disabled', 'true');
    $favBtn.title = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
    $chatBtn.title = '‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
    $openOffer.title = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ';
  }

  function flash(msg, error=false){
    $flash.textContent = msg;
    $flash.style.background = error ? '#fdecec' : '#e8f7ef';
    $flash.style.color = error ? '#7f1d1d' : '#14532d';
    $flash.style.borderColor = error ? '#fecaca' : '#bbf7d0';
    $flash.hidden = false;
    setTimeout(()=>{ $flash.hidden = true; }, 2200);
  }

  /* ===== Modal logic ===== */
  function openOfferModal(){ $mBackdrop.classList.add('open'); $mModal.classList.add('open'); }
  function closeOfferModal(){ $mBackdrop.classList.remove('open'); $mModal.classList.remove('open'); }
  document.getElementById('offerClose').addEventListener('click', closeOfferModal);
  document.getElementById('offerBackdrop').addEventListener('click', closeOfferModal);

  document.getElementById('openOffer').addEventListener('click', async () => {
    // ‡πÇ‡∏´‡∏•‡∏î ‚Äú‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‚Äù
    $mGrid.innerHTML = '';
    $mHint.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô‚Ä¶';
    openOfferModal();
    try{
      const r = await fetch(API.listMine, {credentials:'include', cache:'no-store'});
      const d = await r.json();
      if (!d?.ok){ $mHint.textContent = '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; return; }
      if (!Array.isArray(d.items) || d.items.length===0){
        $mHint.textContent = '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡πà‡∏≠‡∏ô';
        return;
      }
      $mHint.textContent = '';
      const fr = document.createDocumentFragment();
      d.items.forEach(it=>{
        const art = document.createElement('article');
        art.className='my-card';
        art.innerHTML = `
          <div class="my-thumb" style="background-image:url('${it.thumbnail_url||''}')"></div>
          <div class="my-body">
            <div style="font-weight:700">${escapeHtml(it.title||'-')}</div>
            <label class="radio-row">
              <input type="radio" name="offerItem" value="${it.id}">
              ‡πÉ‡∏ä‡πâ‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å
            </label>
          </div>
        `;
        fr.appendChild(art);
      });
      $mGrid.appendChild(fr);
    }catch(e){
      $mHint.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
    }
  });

  $mSubmit.addEventListener('click', async ()=>{
    const chosen = document.querySelector('input[name="offerItem"]:checked');
    if(!chosen){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏Å'); return; }
    const fd = new FormData();
    fd.append('target_item_id', itemId);
    fd.append('offer_item_id', chosen.value);
    fd.append('note', $mNote.value||'');

    $mSubmit.disabled = true;
    try{
      const r = await fetch(API.createReq, {method:'POST', body:fd, credentials:'include', cache:'no-store'});
      const raw = await r.text(); let d;
      try{ d = JSON.parse(raw); }catch{ alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+raw.slice(0,120)); return; }
      if(!d.ok){ alert('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(d.error||'unknown')); return; }
      closeOfferModal();
      flash('‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
      refreshBadges();
    }finally{ $mSubmit.disabled = false; }
  });

  async function refreshBadges(){
    try{
      const r = await fetch(API.badge, {credentials:'include', cache:'no-store'});
      const b = await r.json();
      const el = document.getElementById('reqBadge');
      const el2= document.getElementById('reqBadgeMobile');
      if(el){ el.hidden = !b.incoming_requests; el.textContent = b.incoming_requests||''; }
      if(el2){ el2.hidden = !b.incoming_requests; el2.textContent = b.incoming_requests||''; }
    }catch{}
  }

  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
})();
</script>

  </body>
</html>
