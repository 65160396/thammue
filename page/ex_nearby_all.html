<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>แนะนำทั้งหมด | THAMMUE</title>
  <link rel="stylesheet" href="/css/ex.exchange.css">
  <link rel="stylesheet" href="/css/ex.header.css">
  <style>
    body{background:#f6f8fb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .head{display:flex;justify-content:space-between;align-items:center;margin:8px 0 12px}
    .head h2{margin:0;font-weight:800}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}

    /* การ์ดเป็นลิงก์ทั้งใบ แต่ตัดสไตล์ลิงก์ทิ้ง */
    .card{
      position:relative;
      background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;
      transition:box-shadow .18s ease, transform .18s ease, border-color .18s ease;
    }
    .card:hover{ border-color:#e3e7ef; box-shadow:0 8px 22px rgba(15,23,42,.08); transform:translateY(-1px); }

    .card-link{
      display:block; height:100%;
      color:inherit; text-decoration:none;
      position:relative; z-index:1; /* ให้ปุ่มสามจุดวางทับได้ */
    }

    .thumb{aspect-ratio:4/3;background:#f3f4f6;background-size:cover;background-position:center}
    .body{padding:10px}
    .title{font-weight:800;margin:0 0 6px;line-height:1.25}
    .meta{font-size:.9rem;color:#64748b}
    .more{margin:16px 0;display:flex;justify-content:center}
    .btn{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .muted{color:#64748b}

    /* ===== ปุ่มสามจุดจากสคริปต์ของคุณ ===== */
    .ex-card-kebab{
      position:absolute; top:8px; right:8px; z-index:2;
      width:32px; height:32px; border-radius:8px;
      border:1px solid rgba(0,0,0,.08); background:#fff;
      display:grid; place-items:center; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .ex-card-menu{
      position:absolute; top:44px; right:8px; z-index:3;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px;
      box-shadow:0 12px 24px rgba(15,23,42,.12); min-width:180px;
      display:none;
    }
    .ex-card-menu.open{ display:block }
    .ex-card-menu button{
      width:100%; padding:10px 12px; background:#fff; border:0; text-align:left;
      font-size:14px; cursor:pointer;
    }
    .ex-card-menu button:hover{ background:#f6f8fb }
    .ex-menu-danger{ color:#b42318 }
    .ex-menu-muted{ color:#475569 }
  </style>
</head>
<body>
  <div data-include="/page/partials/ex_header.html"></div>

  <main class="wrap">
    <div class="head">
      <h2>แนะนำทั้งหมด</h2>
      <a class="muted" href="/page/ex_index.html">⟵ กลับหน้าแรก</a>
    </div>

    <div id="list" class="grid" aria-live="polite"></div>
    <div id="empty" class="muted" style="display:none">ยังไม่มีรายการ</div>

    <div class="more">
      <button id="loadMore" class="btn">โหลดเพิ่ม</button>
    </div>
  </main>

  <script src="/js/ex.include.js"></script>
  <script src="/js/me.js"></script>
  <script src="/js/ex.header.js"></script>
  <script src="/js/ex.cards.kebab.js"></script>

  <script>
  (function(){
    const API = '/page/backend/ex_items_search.php';

    const $list  = document.getElementById('list');
    const $empty = document.getElementById('empty');
    const $btn   = document.getElementById('loadMore');

    let page = 0;
    const limit = 24;
    let loading = false;
    let done = false;

    function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
    function pick(...arr){ for (const v of arr) if (v != null && v !== '') return v; return ''; }

    function resolveOwner(it){
      return pick(it.owner_id, it.user_id, it.seller_id, it.ownerId, it.userId, it.sellerId, null);
    }

    function card(it){
      const href  = `/page/ex_item_view.html?id=${encodeURIComponent(it.id)}`;
      const img   = pick(it.thumbnail_url, it.images?.[0], '');
      const title = esc(it.title || '-');
      const area  = [pick(it.addr_province, it.province, ''), pick(it.addr_subdistrict, it.subdistrict, '')]
                      .filter(Boolean).join(' · ');

      const el = document.createElement('article');
      el.className = 'ex-card-x card';
      el.setAttribute('data-id', it.id);
      const owner = resolveOwner(it);
      if (owner != null && owner !== '') el.setAttribute('data-user', String(owner));

      el.innerHTML = `
        <a class="card-link" href="${href}" aria-label="ดูรายละเอียดสินค้า">
          <div class="thumb" style="background-image:url('${img}')"></div>
          <div class="body">
            <div class="title">${title}</div>
            <div class="meta">${esc(area || '-')}</div>
          </div>
        </a>
      `;
      return el;
    }

    async function load(){
      if (loading || done) return;
      loading = true; $btn.disabled = true; $btn.textContent = 'กำลังโหลด...';

      try{
        const url = new URL(API, location.origin);
        url.searchParams.set('limit', String(limit));
        url.searchParams.set('offset', String(page * limit));

        const res = await fetch(url, {credentials:'include', cache:'no-store'});
        const txt = await res.text();
        let json = null; try{ json = JSON.parse(txt); }catch(e){ console.error('Not JSON:', txt); }

        const items = Array.isArray(json?.items) ? json.items
                      : Array.isArray(json) ? json : [];

        if (page === 0 && items.length === 0) $empty.style.display = '';

        const frag = document.createDocumentFragment();
        items.forEach(it => frag.appendChild(card(it)));
        $list.appendChild(frag);

        /* ติดตั้งเมนูสามจุดให้การ์ดใหม่ */
        if (window.ExCardsKebab?.init) ExCardsKebab.init($list);

        if (items.length < limit) {
          done = true;
          $btn.style.display = 'none';
        }
        page++;
      }catch(err){
        console.error('load items failed:', err);
      }finally{
        loading = false;
        if (!done){ $btn.disabled = false; $btn.textContent = 'โหลดเพิ่ม'; }
      }
    }

    $btn.addEventListener('click', load);
    load(); // หน้าแรก
  })();
  </script>
</body>
</html>
