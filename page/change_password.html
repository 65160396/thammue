<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Thammue – บัญชีของฉัน</title>
        <link rel="stylesheet" href="/css/style.css" />
        <link rel="stylesheet" href="/css/open-shop.css" />
        <link rel="stylesheet" href="/css/dropdownmenu.css" />

    </head>

    <body class="open-shop">

        <!-- topbar -->
        <ul class="top-nav">
            <li><a href="/page/upload_product.html">อัพโหลดสินค้า</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="/page/main.html">ซื้อสินค้า</a></li>
            <li class="right"><a href="#notification">แจ้งเตือน</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="#help">ช่วยเหลือ</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="#lang">ไทย</a></li>
        </ul>

        <!-- Header หลัก -->
        <div class="header-wrapper">
            <div class="logo-container">
                <a href="/page/main.html" class="brand-text">THAMMUE</a>
            </div>

            <div class="search-container">
                <div class="search-group">
                    <input type="text" placeholder="ค้นหาสินค้า" />
                    <button class="search-button" aria-label="ค้นหา">
                        <img src="/img/Icon/search.png" alt="ค้นหา" />
                    </button>
                </div>

                <div class="icon-buttons">
                    <button class="action-button"><img src="/img/Icon/heart.png"
                            alt="รายการโปรด" /></button>
                    <button class="action-button"><img
                            src="/img/Icon/shopping-cart.png"
                            alt="ตะกร้า" /></button>
                    <button class="action-button"><img src="/img/Icon/chat.png"
                            alt="แชท" /></button>

                    <!-- ▼ โปรไฟล์ + ชื่อ + เมนูดรอปดาวน์ -->
                    <div class="user-menu" id="userMenu">
                        <button class="user-area" id="userArea"
                            aria-haspopup="true" aria-expanded="false">
                            <img src="/img/Icon/user.png" alt="โปรไฟล์" />
                            <span class="user-chip" id="userChip" hidden></span>
                            <svg class="chev" viewBox="0 0 20 20"
                                aria-hidden="true">
                                <path d="M5.5 7.5l4.5 4 4.5-4" fill="none"
                                    stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </button>

                        <div class="user-dropdown" id="userDropdown"
                            role="menu">
                            <!-- JS จะเติมรายการให้ (guest: login/register, user: account/orders/logout) -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <main class="account-wrap">
            <!-- เมนูซ้าย -->
            <aside class="account-sidenav">
                <nav class="account-nav" aria-label="เมนูบัญชี">
                    <a href="/page/profile.html"
                        data-path="profile.html">บัญชีของฉัน</a>
                    <a href="/page/change_password.html"
                        data-path="change_password.html">เปลี่ยนรหัสผ่าน</a>
                    <a href="/page/my_order.html"
                        data-path="my_order.html">การซื้อของฉัน</a>
                    <a href="/page/favorites.html"
                        data-path="favorites.html">รายการโปรด</a>
                    <a href="/page/privacy_settings.html"
                        data-path="privacy_settings.html">การตั้งค่าความเป็นส่วนตัว</a>
                </nav>

            </aside>

            <!-- เนื้อหาขวา -->
            <section class="account-content">
                <form id="cpForm" class="account-card form-v2"
                    autocomplete="off">
                    <!-- STEP 1: อีเมล + ปุ่ม -->
                    <section id="cp-step1">
                        <h1 class="account-title">อีเมลและรหัสผ่าน</h1>
                        <div class="field">
                            <label>อีเมล</label>
                            <div id="emailDisplay"
                                class="email-note">กำลังโหลดอีเมล…</div>
                        </div>
                        <div class="actions"
                            style="justify-content:center; margin-top:28px;">
                            <button type="button" id="cpNext"
                                class="btn">เปลี่ยนรหัสผ่าน</button>
                        </div>
                    </section>

                    <!-- STEP 2: ฟอร์มเปลี่ยนรหัสผ่าน -->
                    <section id="cp-step2" hidden>
                        <h1 class="account-title">เปลี่ยนรหัสผ่าน</h1>

                        <div class="field required">
                            <label
                                for="current_password">รหัสผ่านปัจจุบัน</label>
                            <input id="current_password" name="current_password"
                                type="password" required />
                        </div>

                        <div class="field required">
                            <label for="new_password">รหัสผ่านใหม่</label>
                            <input id="new_password" name="new_password"
                                type="password" minlength="8" required />
                            <div class="hint">อย่างน้อย 8 ตัวอักษร</div>
                        </div>

                        <div class="field required">
                            <label
                                for="confirm_password">ยืนยันรหัสผ่านใหม่</label>
                            <input id="confirm_password" name="confirm_password"
                                type="password" required />
                        </div>

                        <div class="actions" style="gap:8px; margin-top:18px;">
                            <button type="button" class="btn ghost"
                                id="cpBack">ย้อนกลับ</button>
                            <button type="submit"
                                class="btn">เปลี่ยนรหัสผ่าน</button>
                        </div>
                    </section>

                    <!-- STEP 3: สำเร็จ -->
                    <section id="cp-step3" hidden>
                        <h1 class="account-title">เปลี่ยนรหัสผ่านสำเร็จ</h1>
                        <p>คุณได้เปลี่ยนรหัสผ่านเรียบร้อยแล้ว</p>
                        <div class="actions"
                            style="justify-content:flex-start;">
                            <a href="/page/profile.html"
                                class="btn">กลับไปที่บัญชีของฉัน</a>
                        </div>
                    </section>
                </form>
            </section>

        </main>
        <script src="/exchangepage/js/address.js"></script>

        <script>
(function () {
  // ไฮไลต์เมนูซ้ายตามไฟล์ปัจจุบัน
  const path = location.pathname.split('/').pop();
  document.querySelectorAll('.account-nav a').forEach(a=>{
    if (a.dataset.path === path) a.classList.add('is-active');
  });

  // เติม * อัตโนมัติให้ label ที่มี required
  document.querySelectorAll('.field').forEach(f=>{
    if (f.querySelector('input[required],select[required],textarea[required]')) {
      f.classList.add('required');
    }
  });

  // วัน/เดือน/ปี (ค.ศ.)
  const $d = document.getElementById('dobDay');
  const $m = document.getElementById('dobMonth');
  const $y = document.getElementById('dobYear');
  function fillDOB(){
    if(!$d||!$m||!$y) return;
    $d.innerHTML = '<option value="">วัน</option>';
    for(let i=1;i<=31;i++) $d.insertAdjacentHTML('beforeend', `<option value="${String(i).padStart(2,'0')}">${i}</option>`);
    const months = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
    $m.innerHTML = '<option value="">เดือน</option>';
    months.forEach((t,i)=> $m.insertAdjacentHTML('beforeend', `<option value="${String(i+1).padStart(2,'0')}">${t}</option>`));
    const now = new Date().getFullYear();
    $y.innerHTML = '<option value="">ปี (ค.ศ.)</option>';
    for(let y=now-16; y>=now-100; y--) $y.insertAdjacentHTML('beforeend', `<option value="${y}">${y}</option>`);
  }
  fillDOB();

  // จำกัดเลขเบอร์/ไปรษณีย์
  const phone = document.getElementById('phone');
  const post  = document.getElementById('addr_postcode');
  phone?.addEventListener('input', ()=> phone.value = phone.value.replace(/\D/g,'').slice(0,10));
  post ?.addEventListener('input', ()=> post .value = post .value.replace(/\D/g,'').slice(0,5));

  // โหลดตัวเลือกจังหวัด/อำเภอ/ตำบล
  if (typeof initThaiAddress === 'function') {
    initThaiAddress({
      province:    '#addr_province',
      district:    '#addr_district',
      subdistrict: '#addr_subdistrict',
      postcode:    '#addr_postcode'
    });
  }

  // เติมข้อมูลจาก me.php (ถ้ามี) โดยไม่ทับค่าที่ผู้ใช้กรอกอยู่
  fetch('/page/backend/me.php', {cache:'no-store'})
    .then(r=>r.ok?r.json():{ok:false})
    .then(d=>{
      if(!d || !d.ok) return;
      const u = d.user || {};
      const set = (id,v)=>{ const el=document.getElementById(id); if(el && !el.value && v){ el.value=v; } };
      set('first_name', u.first_name || (u.name||'').split(' ')[0]);
      set('last_name',  u.last_name);
      set('phone',      u.phone);
      set('addr_line',  u.addr_line);
      set('addr_postcode', u.addr_postcode);
      if(u.dob){ const [yy,mm,dd]=(u.dob+'').split('-'); if(yy&&mm&&dd){ $y.value=yy; $m.value=mm; $d.value=dd; } }
    }).catch(()=>{});
})();
</script>


        <!-- ดึงชื่อผู้ใช้จาก me.php และจัดการเมนูดรอปดาวน์ -->
        <script>
      //ดึงชื่อผู้ใช้ข้างไอคอนจาก me.php
      (function () {
        const chip = document.getElementById('userChip');
        const userArea = document.getElementById('userArea');
        if (!chip || !userArea) return;

        fetch('/page/backend/me.php', { cache: 'no-store' })
          .then(r => r.ok ? r.json() : { ok:false })
          .then(d => {
            if (!d || !d.ok) { // ไม่ล็อกอิน
              chip.hidden = true; //    ซ่อนชื่อ
              userArea.href = '/page/login.html';  // กดปุ่มโปรไฟล์แล้วพาไปหน้า login
              return;
            }
              //กรณี “ล็อกอินแล้ว”
            const name = (d.user && (d.user.display_name || d.user.name) || '').trim();
            if (name) { 
              chip.textContent = name; // เติมชื่อ
              chip.hidden = false; }  // โชว์ชื่อ
          })
          .catch(() => { chip.hidden = true; }); // มี error ก็ซ่อนชื่อไว้
      })();
    </script>

        <!---เมนูดรอปดาวน์ และควบคุมเปิด/ปิด---!-->
        <script>
(() => {
  const menu = document.getElementById('userMenu');
  const btn  = document.getElementById('userArea');
  const chip = document.getElementById('userChip');
  const dd   = document.getElementById('userDropdown');
  if (!menu || !btn || !chip || !dd) return;

  // ค่าเริ่มต้นสำหรับผู้ที่ยังไม่ล็อกอิน
  dd.innerHTML = `
    <a href="/page/login.html" role="menuitem">เข้าสู่ระบบ</a>
    <a href="/page/add_member.html" role="menuitem">สมัครสมาชิก</a>
  `;

  // ดึงชื่อผู้ใช้จาก PHP
  fetch('/page/backend/me.php', { cache:'no-store' })
    .then(r => r.ok ? r.json() : {ok:false})
    .then(d => {
      if (d && d.ok) {
        const name = (d.user.display_name || d.user.name || '').trim();
        if (name) { chip.textContent = name; chip.hidden = false; }
        dd.innerHTML = `
          <a href="/page/profile.html" role="menuitem">บัญชีของฉัน</a>
          <a href="/page/my_order.html" role="menuitem">การซื้อของฉัน</a>
          <a href="/page/change_password.html" role="menuitem">เปลี่ยนรหัสผ่าน</a>
          <hr>
          <a href="/page/backend/logout.php" role="menuitem" class="logout">ออกจากระบบ</a>
        `;
      } else {
        chip.hidden = true; 
      }
    })
    .catch(() => { chip.hidden = true; });

  // เปิด/ปิดด้วยคลิก (สำหรับมือถือ)
  btn.addEventListener('click', e => {
    e.preventDefault();
    const open = menu.classList.toggle('open');
    btn.setAttribute('aria-expanded', open);
  });

  // ปิดเมื่อคลิกข้างนอกหรือกด Esc
  document.addEventListener('click', e => {
    if (!menu.contains(e.target)) { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); }
  });
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') { menu.classList.remove('open'); btn.setAttribute('aria-expanded','false'); btn.blur(); }
  });
})();
</script>

        <script>
(function(){
  // ----- STEP 1 -----
  const emailEl = document.getElementById('emailDisplay');
  if (emailEl) {
    fetch('/page/backend/me.php', { cache: 'no-store' })
      .then(r => r.ok ? r.json() : { ok:false })
      .then(d => {
        if (!d || !d.ok) { emailEl.textContent = 'ยังไม่ได้เข้าสู่ระบบ'; return; }
        emailEl.textContent = (d.user && d.user.email) ? d.user.email : 'ไม่พบอีเมลในบัญชี';
      })
      .catch(() => { emailEl.textContent = 'โหลดอีเมลไม่สำเร็จ'; });
  }

  const s1 = document.getElementById('cp-step1');
  const s2 = document.getElementById('cp-step2');
  const s3 = document.getElementById('cp-step3');
  const nextBtn = document.getElementById('cpNext');
  const backBtn = document.getElementById('cpBack');
  const form    = document.getElementById('cpForm');

  function show(step){
    if (!s1 || !s2) return;
    s1.hidden = step !== 1;
    s2.hidden = step !== 2;
    if (s3) s3.hidden = step !== 3;
    // อัปเดต query param ?step=
    const url = new URL(location.href);
    url.searchParams.set('step', step);
    history.replaceState(null, '', url);
  }

  // เปิดตาม query ?step (ถ้ามี)
  const initStep = parseInt(new URLSearchParams(location.search).get('step') || '1', 10);
  show([1,2,3].includes(initStep) ? initStep : 1);

  nextBtn?.addEventListener('click', ()=> show(2));
  backBtn?.addEventListener('click', ()=> show(1));

  // ----- STEP 2 -----
  form?.addEventListener('submit', async (e)=>{
    if (s2?.hidden) return; // ส่งเฉพาะตอนอยู่ step 2
    e.preventDefault();

    const current = document.getElementById('current_password').value.trim();
    const npw     = document.getElementById('new_password').value.trim();
    const cf      = document.getElementById('confirm_password').value.trim();

    if (!current || !npw || !cf) return alert('กรอกข้อมูลให้ครบ');
    if (npw.length < 8)          return alert('รหัสผ่านใหม่อย่างน้อย 8 ตัวอักษร');
    if (npw !== cf)              return alert('รหัสผ่านใหม่และยืนยันไม่ตรงกัน');

    try{
      const res = await fetch('/page/backend/change_password.php', {
        method: 'POST',
        headers: { 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ current_password: current, new_password: npw })
      });
      const data = await res.json().catch(()=>({ok:false}));
      if (res.ok && data.ok) {
        show(3); // ไปหน้า “สำเร็จ”
      } else {
        alert(data.message || 'เปลี่ยนรหัสผ่านไม่สำเร็จ');
      }
    }catch(err){
      alert('เปลี่ยนรหัสผ่านไม่สำเร็จ (เครือข่าย)');
    }
  });
})();
</script>

    </body>
</html>
