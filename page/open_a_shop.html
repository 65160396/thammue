<!DOCTYPE html>
<html lang="th">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Thammue – เปิดร้านค้า</title>
        <link rel="stylesheet" href="/css/style.css" />
        <link rel="stylesheet" href="/css/open-shop.css" />
    </head>
    <body class="open-shop">
        <!-- topbar -->
        <ul class="top-nav">
            <li><a href="/page/upload_product.html">อัพโหลดสินค้า</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="/page/main.html">ซื้อสินค้า</a></li>
            <li class="right"><a href="#notification">แจ้งเตือน</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="#help">ช่วยเหลือ</a></li>
            <li><span class="top-divider">|</span></li>
            <li><a href="#lang">ไทย</a></li>
        </ul>

        <!-- Header หลัก -->
        <div class="header-wrapper">
            <div class="logo-container">
                <a href="/page/main.html" class="brand-text">THAMMUE</a>
            </div>

            <div class="search-container">
                <div class="search-group">
                    <input type="text" placeholder="ค้นหาสินค้า" />
                    <button class="search-button" aria-label="ค้นหา">
                        <img src="/img/Icon/search.png" alt="ค้นหา" />
                    </button>
                </div>

                <div class="icon-buttons">
                    <button class="action-button"><img src="/img/Icon/heart.png"
                            alt="รายการโปรด" /></button>
                    <button class="action-button"><img
                            src="/img/Icon/shopping-cart.png"
                            alt="ตะกร้า" /></button>
                    <button class="action-button"><img src="/img/Icon/chat.png"
                            alt="แชท" /></button>

                    <!-- ▼ โปรไฟล์ + ชื่อ + เมนูดรอปดาวน์ -->
                    <div class="user-menu" id="userMenu">
                        <button class="user-area" id="userArea"
                            aria-haspopup="true" aria-expanded="false">
                            <img src="/img/Icon/user.png" alt="โปรไฟล์" />
                            <span class="user-chip" id="userChip" hidden></span>
                            <svg class="chev" viewBox="0 0 20 20"
                                aria-hidden="true">
                                <path d="M5.5 7.5l4.5 4 4.5-4" fill="none"
                                    stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </button>
                        <div class="user-dropdown" id="userDropdown"
                            role="menu"></div>
                    </div>
                </div>
            </div>
        </div>

        <main class="wizard-page">
            <section class="wizard-card">
                <!-- Stepper -->
                <nav class="stepper" aria-label="ขั้นตอนการเปิดร้าน">
                    <div class="step is-active" data-step="1"><span
                            class="dot"></span><span
                            class="label">ข้อมูลร้านค้า</span></div>
                    <div class="step" data-step="2"><span
                            class="dot"></span><span
                            class="label">ยืนยันตัวตน</span></div>
                    <div class="step" data-step="3"><span
                            class="dot"></span><span
                            class="label">ส่งแบบฟอร์ม</span></div>
                </nav>

                <!-- ฟอร์ม -->
                <form id="openShopForm"
                    action="/page/backend/save_open_shop.php" method="post"
                    enctype="multipart/form-data" autocomplete="off">
                    <!-- STEP 1 -->
                    <section id="step1" class="panel form-v2">
                        <div class="field">
                            <label for="shop_name">ชื่อร้านค้า</label>
                            <input id="shop_name" name="shop_name" type="text"
                                required />
                        </div>

                        <div class="grid2">
                            <div class="field">
                                <label for="pickup_province">จังหวัด</label>
                                <select id="pickup_province"
                                    name="pickup_province" required>
                                    <option value selected disabled>—
                                        เลือกจังหวัด —</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="pickup_district">อำเภอ/เขต</label>
                                <select id="pickup_district"
                                    name="pickup_district" required disabled>
                                    <option value selected disabled>—
                                        เลือกอำเภอ/เขต —</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid2">
                            <div class="field">
                                <label
                                    for="pickup_subdistrict">ตำบล/แขวง</label>
                                <select id="pickup_subdistrict"
                                    name="pickup_subdistrict" required disabled>
                                    <option value selected disabled>—
                                        เลือกตำบล/แขวง —</option>
                                </select>
                            </div>
                            <div class="field">
                                <label
                                    for="pickup_postcode">รหัสไปรษณีย์</label>
                                <input id="pickup_postcode"
                                    name="pickup_postcode" type="text"
                                    inputmode="numeric" maxlength="5"
                                    required />
                            </div>
                        </div>

                        <div class="field">
                            <label
                                for="pickup_addr_line">รายละเอียดที่เข้ารับพัสดุ</label>
                            <input id="pickup_addr_line" name="pickup_addr_line"
                                type="text" required />
                        </div>

                        <!-- hidden รวม address เพื่อส่งเข้า PHP -->
                        <input type="hidden" id="pickup_addr"
                            name="pickup_addr" />

                        <div class="field">
                            <label for="email">อีเมล์</label>
                            <input id="email" name="email" type="email"
                                required />
                        </div>
                        <div class="field">
                            <label for="phone">หมายเลขโทรศัพท์</label>
                            <input id="phone" name="phone" type="tel"
                                inputmode="numeric" autocomplete="tel"
                                maxlength="10" pattern="[0-9]{9,10}" required />
                        </div>

                        <div class="actions">
                            <button type="button" class="btn"
                                data-next>ถัดไป</button>
                        </div>
                    </section>

                    <!-- STEP 2 -->
                    <section id="step2" class="panel" hidden>
                        <div class="field inline">
                            <label>ประเภทผู้ขาย</label>
                            <div class="radio-row">
                                <label><input type="radio" name="seller_type"
                                        value="person" required />
                                    บุคคลธรรมดา</label>
                                <label><input type="radio" name="seller_type"
                                        value="company" /> นิติบุคคล</label>
                            </div>
                            <div class="hint" id="typeHint"
                                hidden>กรุณาเลือกประเภทผู้ขาย</div>
                        </div>

                        <!-- บุคคลธรรมดา -->
                        <div id="personFields" class="type-group" hidden>
                            <div class="field">
                                <label for="citizen_name">ชื่อ-นามสกุล</label>
                                <input id="citizen_name" name="citizen_name"
                                    type="text" disabled required />
                            </div>

                            <div class="field required">
                                <label>วันเดือนปีเกิด</label>
                                <div class="dob-row"
                                    style="display:flex; gap:10px; align-items:center;">
                                    <select id="dobDay" aria-label="วัน"
                                        required disabled></select>
                                    <select id="dobMonth" aria-label="เดือน"
                                        required disabled></select>
                                    <select id="dobYearBE" aria-label="พ.ศ."
                                        required disabled></select>
                                </div>
                                <input type="hidden" name="dob_iso"
                                    id="dobIso" />
                                <div class="hint" id="dobHint"
                                    hidden>กรุณาเลือกวันเดือนปีเกิดให้ถูกต้อง
                                    (อายุ 18+)</div>
                            </div>

                            <div class="field">
                                <label for="citizen_id">เลขบัตรประชาชน (13
                                    หลัก)</label>
                                <input id="citizen_id" name="citizen_id"
                                    inputmode="numeric" maxlength="13"
                                    pattern="\d{13}" disabled required />
                            </div>

                            <h3 class="form-section">ที่อยู่ตามบัตรประชาชน</h3>

                            <div class="grid2">
                                <div class="field">
                                    <label for="cid_province">จังหวัด</label>
                                    <select id="cid_province" name="province"
                                        disabled required>
                                        <option value selected disabled>—
                                            เลือกจังหวัด —</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="cid_district">อำเภอ/เขต</label>
                                    <select id="cid_district" name="district"
                                        disabled required>
                                        <option value selected disabled>—
                                            เลือกอำเภอ/เขต —</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid2">
                                <div class="field">
                                    <label
                                        for="cid_subdistrict">ตำบล/แขวง</label>
                                    <select id="cid_subdistrict"
                                        name="subdistrict" disabled required>
                                        <option value selected disabled>—
                                            เลือกตำบล/แขวง —</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="postcode">รหัสไปรษณีย์</label>
                                    <input id="postcode" name="postcode"
                                        inputmode="numeric" maxlength="5"
                                        disabled required />
                                    <!-- hint กัน error -->
                                    <div class="hint" id="postcodeHint"
                                        hidden>รหัสไปรษณีย์ 5 หลัก</div>
                                </div>
                            </div>

                            <div class="field">
                                <label
                                    for="addr_line">รายละเอียดที่อยู่ตามบัตร</label>
                                <input id="addr_line" name="addr_line"
                                    placeholder="บ้านเลขที่ หมู่ ซอย ถนน"
                                    disabled required />
                            </div>

                            <div class="grid2">
                                <div class="field">
                                    <label
                                        for="id_front">บัตรประชาชนด้านหน้า</label>
                                    <input type="file" id="id_front"
                                        name="id_front"
                                        accept="image/jpeg,image/png,application/pdf"
                                        disabled required />
                                </div>
                            </div>
                        </div>

                        <!-- นิติบุคคล -->
                        <div id="companyFields" class="type-group" hidden>
                            <div class="field inline">
                                <label>ประเภทนิติบุคคล</label>
                                <div class="radio-row">
                                    <label><input type="radio" name="corp_kind"
                                            value="company_limited" required
                                            disabled /> บริษัทจำกัด</label>
                                    <label><input type="radio" name="corp_kind"
                                            value="public_company_limited"
                                            disabled /> บริษัทจำกัดมหาชน</label>
                                    <label><input type="radio" name="corp_kind"
                                            value="partnership_juristic"
                                            disabled />
                                        ห้างหุ้นส่วนสามัญนิติบุคคล</label>
                                    <label><input type="radio" name="corp_kind"
                                            value="partnership_limited"
                                            disabled />
                                        ห้างหุ้นส่วนจำกัด</label>
                                </div>
                            </div>

                            <div class="field">
                                <label for="company_name">ชื่อบริษัท</label>
                                <input id="company_name" name="company_name"
                                    type="text" disabled required />
                            </div>

                            <div class="field">
                                <label for="tax_id">เลขทะเบียนนิติบุคคล (10–13
                                    หลัก)</label>
                                <input id="tax_id" name="tax_id"
                                    inputmode="numeric" maxlength="13"
                                    pattern="\d{10,13}" disabled required />
                            </div>

                            <h3 class="form-section">ที่อยู่จดทะเบียนบริษัท</h3>

                            <div class="grid2">
                                <div class="field">
                                    <label for="co_province">จังหวัด</label>
                                    <select id="co_province" disabled required>
                                        <option value selected disabled>—
                                            เลือกจังหวัด —</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label for="co_district">อำเภอ/เขต</label>
                                    <select id="co_district" disabled required>
                                        <option value selected disabled>—
                                            เลือกอำเภอ/เขต —</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid2">
                                <div class="field">
                                    <label
                                        for="co_subdistrict">ตำบล/แขวง</label>
                                    <select id="co_subdistrict" disabled
                                        required>
                                        <option value selected disabled>—
                                            เลือกตำบล/แขวง —</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label
                                        for="co_postcode">รหัสไปรษณีย์</label>
                                    <input id="co_postcode" name="co_postcode"
                                        inputmode="numeric" maxlength="5"
                                        disabled required />
                                </div>
                            </div>

                            <div class="field">
                                <label
                                    for="co_addr_line">รายละเอียดที่จดทะเบียนบริษัท</label>
                                <input id="co_addr_line" name="co_addr_line"
                                    placeholder="บ้านเลขที่ หมู่ ซอย ถนน"
                                    disabled required />
                            </div>

                            <div class="field">
                                <label for="reg_doc">หนังสือรับรองบริษัท</label>
                                <input type="file" id="reg_doc" name="reg_doc"
                                    accept="application/pdf,image/jpeg,image/png"
                                    disabled required />
                            </div>

                            <div class="field">
                                <label
                                    for="id_rep">บัตรประชาชนผู้มีอำนาจลงนาม</label>
                                <input type="file" id="id_rep" name="id_rep"
                                    accept="application/pdf,image/jpeg,image/png"
                                    disabled required />
                            </div>
                        </div>

                        <div class="actions">
                            <button type="button" class="btn ghost"
                                data-prev>ย้อนกลับ</button>
                            <button type="button" class="btn"
                                data-next>ถัดไป</button>
                        </div>
                    </section>

                    <!-- STEP 3 -->
                    <section id="step3" class="panel" hidden>
                        <div class="actions">
                            <button type="button" class="btn ghost"
                                data-prev>ย้อนกลับ</button>
                            <button type="submit"
                                class="btn">ส่งแบบฟอร์ม</button>
                        </div>
                    </section>
                </form>
            </section>
        </main>

        <!-- วางตรงนี้ ใต้ </form> หรือก่อนสคริปต์อื่นทั้งหมด -->
        <script>
(async () => {
  // โชว์ฟอร์มทันที
  const form = document.getElementById('openShopForm');
  if (form) form.style.visibility = 'visible';

  const getJSON = (url) =>
    fetch(url, { credentials: 'include', cache: 'no-store' })
      .then(r => r.ok ? r.json() : null)
      .catch(() => null);

  // ยิงคู่ขนาน
  const meP   = getJSON('/page/backend/me.php?ts=' + Date.now());
  const shopP = getJSON('/page/backend/productsforsale/get_shop.php');

  // พรีฟิลทันทีที่ได้ me (ไม่ต้องรออีกตัว)
  meP.then(ud => {
    if (!ud || !ud.ok || !ud.user) return;
    const set = (id, val) => {
      const el = document.getElementById(id);
      if (el && !el.value && val != null) el.value = String(val);
    };
    set('email', ud.user.email);
    set('phone', ud.user.phone);
    const cn = document.getElementById('citizen_name');
    if (cn && !cn.value) cn.value = ud.user.display_name || ud.user.name || '';
  });

  // มีร้าน/ไม่ได้ล็อกอิน → ค่อยรีไดเรกต์เมื่อรู้ผล
  shopP.then(d => {
    if (!d) return;
    if (d.ok && d.shop) {
      location.href = `/page/storepage/indexstore.html?shop_id=${encodeURIComponent(d.shop.id)}`;
    } else if (d.code === 'NOT_LOGIN') {
      location.href = '/page/login.php';
    }
  });
})();
</script>

        <script defer src="/js/me.js"></script>
        <script defer src="/js/user-menu.js"></script>
        <script defer src="/js/address.js"></script>
        <script defer src="/js/open-shop/shop-registration.js"></script>

    </body>
</html>
