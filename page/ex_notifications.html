<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô | THAMMUE</title>
    <link rel="stylesheet" href="/css/ex.exchange.css" />
    <link rel="stylesheet" href="/css/ex.header.css" />
    <link rel="stylesheet" href="/css/ex.notifications.css">

  </head>
  <body>
    <body class="ex-noti-page"></body>
    <div data-include="/page/partials/ex_header.html"></div>
    <div class="ex-container">
      <h1 class="ex-h1">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</h1>
      <div class="ex-card">
        <ul id="notis" class="ex-list"></ul>
      </div>
      <p class="ex-muted">* ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        (ex_notifications)</p>
    </div>
    <script src="/js/ex.exchange.js"></script>
    <script src="/js/ex.include.js"></script>
    <script src="/js/me.js"></script>
    <script src="/js/ex.header.js"></script>
    <script>
(function(){
  const list  = document.getElementById('notis');   // ‚Üê ‡πÉ‡∏ä‡πâ UL#notis ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤
  const empty = document.getElementById('empty') || (()=>{
    const d=document.createElement('div');
    d.id='empty'; d.style.color='#64748b';
    list.parentElement.insertBefore(d, list); // ‡∏ß‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    return d;
  })();

  async function load(){
    const r = await fetch('/page/backend/ex_notifications_list.php', {credentials:'include', cache:'no-store'});
    const j = await r.json().catch(()=>null);
    if(!j?.ok){ empty.textContent = j?.error || '‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; list.innerHTML=''; return; }
    if(!j.items.length){ empty.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'; list.innerHTML=''; return; }

    empty.innerHTML = '<button id="markAll" class="btn">‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>';

    list.innerHTML = j.items.map(n=>{
      const typeCls = n.type==='request_accepted' ? 'accept'
                    : n.type==='request_declined' ? 'decline'
                    : 'normal';
      const icon = n.type==='request_accepted' ? '‚úÖ'
                  : n.type==='request_declined' ? '‚ùå' : 'üîî';
      const href = (n.payload?.item_id) ? `/page/ex_item_view.html?id=${n.payload.item_id}` : 'javascript:void(0)';
      const when = new Date((n.created_at||'').replace(' ','T')).toLocaleString();
      const readCls = n.is_read ? 'read' : 'unread';
      return `
        <li>
          <a href="${href}" class="noti ${typeCls} ${readCls}">
            <div class="noti-row">
              <div class="noti-ico">${icon}</div>
              <div class="noti-txt">
                <div class="noti-title">${n.title || '‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô'}</div>
                ${n.body ? `<p class="noti-body">${n.body}</p>` : ''}
              </div>
              <div class="noti-time">${when}</div>
            </div>
          </a>
        </li>
      `;
    }).join('');

    document.getElementById('markAll')?.addEventListener('click', async ()=>{
      await fetch('/page/backend/ex_notifications_mark_read.php',{
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'}, body:'{}'
      });
      load();
      window.refreshExBadges?.(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä badge ‡∏ö‡∏ô header ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    });
  }
  load();
})();

</script>

  </body>
</html>
