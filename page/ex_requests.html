<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>คำขอแลกเปลี่ยน | THAMMUE</title>
    <link rel="stylesheet" href="/css/ex.exchange.css" />
    <link rel="stylesheet" href="/css/ex.header.css" />
    <style>
    body{background:#f6f8fb}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .head{display:flex;justify-content:space-between;align-items:center;margin:6px 0 12px;gap:10px}
    .right-actions{display:flex;gap:8px;flex-wrap:wrap}
    .card{background:#fff;border:1px solid #eef1f5;border-radius:12px;padding:12px;margin:10px 0}
    .row{display:flex;gap:12px;align-items:center}
    .thumb{width:60px;height:60px;border-radius:10px;object-fit:cover;background:#f3f4f6}
    .muted{color:#64748b}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .btn{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;text-decoration:none;color:inherit;display:inline-block}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* ===== Modal ===== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(15,23,42,.4);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .modal{ display:none; }
    .modal.open{ display:block; }
    .dialog{
      width:min(560px, calc(100% - 24px));
      background:#fff; border-radius:16px; border:1px solid #e5e7eb;
      box-shadow: 0 30px 80px rgba(0,0,0,.25);
      overflow:hidden;
      animation: pop .12s ease-out;
    }
    @keyframes pop{ from{ transform:scale(.98); opacity:.6 } to{ transform:scale(1); opacity:1 } }
    .dlg-head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eef2f7}
    .dlg-title{font-weight:800}
    .dlg-close{background:transparent;border:0;font-size:20px;cursor:pointer;line-height:1}
    .dlg-body{padding:14px 16px;display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .fld{display:flex;flex-direction:column;gap:6px}
    .fld label{font-size:13px;color:#475569}
    .fld input[type="date"], .fld input[type="time"], .fld input[type="text"], .fld textarea{
      border:1px solid #cbd5e1; border-radius:10px; padding:10px 12px; font:inherit;
    }
    .dlg-foot{padding:14px 16px;border-top:1px solid #eef2f7;display:flex;justify-content:flex-end;gap:8px}
  </style>
  </head>
  <body>
    <div data-include="/page/partials/ex_header.html"></div>

    <main class="wrap">
      <div class="head">
        <h1 style="margin:0">คำขอแลกเปลี่ยน</h1>
        <div class="right-actions">
          <a class="btn"
            href="/page/ex_status.html">สถานะการแลกเปลี่ยนของฉัน</a>
        </div>
      </div>
      <div id="list"></div>
      <div id="empty" class="muted" style="padding:8px 0"></div>
    </main>

    <!-- ===== Accept Modal ===== -->
    <div id="acceptModal" class="modal" aria-hidden="true">
      <div class="modal-backdrop" role="dialog" aria-modal="true"
        aria-labelledby="dlgTitle">
        <div class="dialog">
          <div class="dlg-head">
            <div class="dlg-title" id="dlgTitle">ยืนยันการยอมรับคำขอ</div>
            <button class="dlg-close" type="button" aria-label="ปิด"
              id="dlgClose">×</button>
          </div>
          <div class="dlg-body">
            <div class="grid2">
              <div class="fld">
                <label for="meetDate">วันนัดรับ</label>
                <input id="meetDate" type="date">
              </div>
              <div class="fld">
                <label for="meetTime">เวลานัดรับ</label>
                <input id="meetTime" type="time">
              </div>
            </div>
            <div class="fld">
              <label for="meetPlace">สถานที่นัดรับ</label>
              <input id="meetPlace" type="text"
                placeholder="เช่น เซเว่นหน้าปากซอย">
            </div>
            <div class="fld">
              <label for="meetNote">หมายเหตุ</label>
              <textarea id="meetNote" rows="3"
                placeholder="ข้อมูลเพิ่มเติม (ถ้ามี)"></textarea>
            </div>
          </div>
          <div class="dlg-foot">
            <button type="button" class="btn"
              id="dlgCancel">ยกเลิก</button>
            <button type="button" class="btn primary"
              id="dlgConfirm">ยืนยันการยอมรับ</button>
          </div>
        </div>
      </div>
    </div>

    <script src="/js/ex.include.js"></script>
    <script src="/js/me.js"></script>
    <script src="/js/ex.header.js"></script>
    <script>
  const API = {
    list:   '/page/backend/ex_requests_list.php',
    decide: '/page/backend/ex_request_decide.php'
  };

  // ===== Modal helpers =====
  const modal = document.getElementById('acceptModal');
  const dlgClose   = document.getElementById('dlgClose');
  const dlgCancel  = document.getElementById('dlgCancel');
  const dlgConfirm = document.getElementById('dlgConfirm');
  const meetDate   = document.getElementById('meetDate');
  const meetTime   = document.getElementById('meetTime');
  const meetPlace  = document.getElementById('meetPlace');
  const meetNote   = document.getElementById('meetNote');
  let currentRequestId = null;

  function openModal(requestId){
    currentRequestId = requestId;
    if (!meetDate.value){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      meetDate.value = `${yyyy}-${mm}-${dd}`;
    }
    modal.classList.add('open');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden','true');
  }
  dlgClose.onclick = dlgCancel.onclick = closeModal;

  // ===== ส่งยืนยันยอมรับ + เก็บนัดหมาย =====
  dlgConfirm.onclick = async () => {
    if (!currentRequestId) return;
    const fd = new FormData();
    fd.append('request_id', currentRequestId);
    fd.append('action','accept');
    if (meetDate.value)  fd.append('meet_date', meetDate.value);
    if (meetTime.value)  fd.append('meet_time', meetTime.value);
    if (meetPlace.value.trim()) fd.append('place', meetPlace.value.trim());
    if (meetNote.value.trim())  fd.append('note',  meetNote.value.trim());

    dlgConfirm.disabled = true;
    try{
      const res = await fetch(API.decide, {method:'POST', body:fd, credentials:'include'});
      const raw = await res.text();
      let data = null; try{ data = JSON.parse(raw); }catch(e){}
      if (data?.ok){
        closeModal();
        // ✅ ข้อความใหม่ + เสนอเปิดหน้าดูนัดหมายทันที
        const go = confirm('บันทึกนัดหมายแล้ว และส่งการแจ้งเตือนให้ผู้ขอเรียบร้อย\nต้องการเปิดหน้า “นัดหมายของฉัน” เลยไหม?');
        if (go) window.location.href = '/page/ex_meetings.html';
        else location.reload();
      }else{
        alert('ทำรายการไม่สำเร็จ\n\nResponse:\n' + raw.slice(0, 400));
        console.error('ex_request_decide.php raw response:', raw);
      }
    }finally{
      dlgConfirm.disabled = false;
    }
  };

  // ===== List rendering =====
  function el(tag, attrs={}, html=''){
    const e=document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v));
    if (html) e.innerHTML = html;
    return e;
  }

  function card(r){
    const c = el('div', {class:'card'});
    const placeLine = r.preferred_place ? `<div class="muted" style="margin-top:4px">สถานที่ที่ผู้ขอเสนอ: ${r.preferred_place}</div>` : '';
    const noteLine  = r.note ? `<div class="muted" style="margin-top:2px">โน้ตจากผู้ขอ: ${r.note}</div>` : '';

    c.innerHTML = `
      <div class="row">
        <img class="thumb" src="${r.off_thumb||''}" alt="">
        <div>
          <div><b>${r.off_title||'-'}</b> <span class="muted">ขอแลกกับ</span></div>
          <div class="muted">${r.req_title||'-'}</div>
          <div class="muted" style="font-size:12px">เมื่อ: ${r.created_at}</div>
          <div class="muted" style="font-size:12px">สถานะ: ${r.status}</div>
          ${placeLine}
          ${noteLine}
        </div>
      </div>
    `;

    if (r.status === 'pending'){
      const act = el('div',{class:'actions'});
      const ok = el('button',{class:'btn primary',type:'button'},'ยอมรับ');
      const no = el('button',{class:'btn',type:'button'},'ปฏิเสธ');

      ok.onclick = () => openModal(r.id);

      no.onclick = async ()=>{
        if (!confirm('ยืนยันปฏิเสธคำขอนี้?')) return;
        const fd = new FormData();
        fd.append('request_id', r.id);
        fd.append('action', 'decline');
        const res = await fetch(API.decide, {method:'POST', body:fd, credentials:'include'});
        const data = await res.json().catch(()=>null);
        if (data?.ok){ alert('ปฏิเสธแล้ว'); location.reload(); }
        else alert('ทำรายการไม่สำเร็จ');
      };
      act.append(ok, no);
      c.appendChild(act);
    }
    return c;
  }

  (async function init(){
    try{
      const r = await fetch(API.list, {credentials:'include', cache:'no-store'});
      const raw = await r.text();
      const d = JSON.parse(raw);
      const list = document.getElementById('list');
      const empty = document.getElementById('empty');
      const arr = (d?.incoming)||[];
      if (!arr.length){ empty.textContent = 'ไม่มีคำขอเข้ามา'; return; }
      const fr = document.createDocumentFragment();
      arr.forEach(x=>fr.appendChild(card(x)));
      list.appendChild(fr);
    }catch(e){
      document.getElementById('empty').textContent = 'โหลดข้อมูลไม่สำเร็จ';
    }
  })();
  </script>
  </body>
</html>
