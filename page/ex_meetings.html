<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ตารางนัดหมายการแลกเปลี่ยน | THAMMUE</title>
  <link rel="stylesheet" href="/css/ex.exchange.css" />
  <link rel="stylesheet" href="/css/ex.header.css" />
  <style>
    body{ background:#f6f8fb; }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .h1{ font-size:1.6rem; font-weight:800; margin:6px 0 14px; }

    .card{ background:#fff; border:1px solid #eef1f5; border-radius:14px; padding:12px; margin:10px 0; }
    .row { display:flex; gap:12px; align-items:flex-start; }
    .thumb{ width:64px; height:64px; flex:0 0 64px; border-radius:12px; object-fit:cover; background:#f3f4f6; }
    .muted{ color:#64748b; }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eef2ff; color:#334155; margin-left:6px; }
    .chip { display:inline-block; background:#f1f5f9; color:#334155; border-radius:999px; padding:4px 8px; font-size:12px; margin-right:6px; }
    .small{ font-size:12px; }

    .two { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px; }
    .box { border:1px dashed #e5e7eb; border-radius:10px; padding:8px 10px; }
    .ttl { font-weight:700; margin-bottom:4px; }

    @media (max-width:900px){ .two{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div data-include="/page/partials/ex_header.html"></div>

  <main class="wrap">
    <div class="h1">ตารางนัดหมายการแลกเปลี่ยน</div>
    <div id="list"></div>
    <div id="empty" class="muted" style="padding:8px 0"></div>
  </main>

  <script src="/js/ex.include.js"></script>
  <script src="/js/me.js"></script>
  <script src="/js/ex.header.js"></script>
  <script>
  (async function(){
    const API = '/page/backend/ex_meetings_list.php';

    function line(label, val){
      const v = (val && String(val).trim()) ? String(val).trim() : '-';
      return `<div><b>${label}</b> ${v}</div>`;
    }

    function itemBlock(title, item){
      const place = item.place_detail ? ` · ${item.place_detail}` : '';
      const area  = item.area ? ` · ${item.area}` : '';
      return `
        <div class="box">
          <div class="ttl">${title}</div>
          <div class="small">${item.title || '-'}</div>
          <div class="small muted">${(item.area||item.place_detail) ? (item.place_detail||'') + area : '-'}</div>
        </div>
      `;
    }

    function card(m){
      const c = document.createElement('div');
      c.className = 'card';

      const sideChip = m.side === 'owner' ? 'ฉันเป็นเจ้าของ' : 'ฉันเป็นผู้ขอ';
      const when = m.meet_when || '-';
      const place = m.meet_place || '-';
      const note  = m.meet_note  || '-';

      c.innerHTML = `
        <div class="row">
          <img class="thumb" src="${m.offered.thumb || m.requested.thumb || ''}" alt="">
          <div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
              <div style="font-weight:800">${m.offered.title || m.requested.title || '—'}</div>
              <span class="chip">${sideChip}</span>
              <span class="badge">สถานะ: ${m.status}</span>
            </div>

            ${line('วันเวลา:', when)}
            ${line('สถานที่:', place)}
            ${line('หมายเหตุ:', note)}
            <div class="small muted" style="margin-top:6px">อัปเดตล่าสุด: ${m.created_at}</div>

            <div class="two">
              ${itemBlock('สินค้า “ของฉัน”',
                 (m.side==='owner') ? m.requested : m.offered)}
              ${itemBlock('สินค้า “ของอีกฝ่าย”',
                 (m.side==='owner') ? m.offered : m.requested)}
            </div>
          </div>
        </div>
      `;
      return c;
    }

    try{
      const res = await fetch(API, {credentials:'include', cache:'no-store'});
      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch(_){}
      if(!data || !data.ok){
        document.getElementById('empty').textContent = 'โหลดข้อมูลไม่สำเร็จ';
        console.error('meetings raw:', raw);
        return;
      }
      const list = document.getElementById('list');
      const arr  = data.meetings || [];
      if(!arr.length){
        document.getElementById('empty').textContent = 'ยังไม่มีนัดหมาย';
        return;
      }
      const fr = document.createDocumentFragment();
      arr.forEach(m => fr.appendChild(card(m)));
      list.appendChild(fr);
    }catch(e){
      document.getElementById('empty').textContent = 'โหลดข้อมูลไม่สำเร็จ';
    }
  })();
  </script>
</body>
</html>
