<!doctype html>
<html lang="th">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ตารางนัดหมายการแลกเปลี่ยน | THAMMUE</title>
    <link rel="stylesheet" href="/css/ex.exchange.css" />
    <link rel="stylesheet" href="/css/ex.header.css" />
    <style>
      body { background:#f6f8fb; }
      .wrap { max-width:1100px; margin:0 auto; padding:16px; }
      .h1 { font-size:1.6rem; font-weight:800; margin:6px 0 14px; }
      .muted { color:#64748b; }
      .meeting-card { background:#fff; border:1px solid #eef1f5; border-radius:14px; padding:12px; margin:10px 0; }
      .row { display:flex; gap:12px; align-items:flex-start; }
      .thumb { width:64px; height:64px; border-radius:12px; object-fit:cover; background:#eef1f5; }
      .left { display:flex; gap:8px; align-items:center; }
      .title { font-weight:700; }
      .meta { font-size:13px; color:#334155; }
    </style>
  </head>

  <body>
    <div data-include="/page/partials/ex_header.html"></div>

    <main class="wrap">
      <div class="h1">ตารางนัดหมายการแลกเปลี่ยน</div>
      <div id="empty" class="muted">กำลังโหลด...</div>
      <div id="list"></div>
    </main>

    <script src="/js/ex.include.js"></script>
    <script src="/js/me.js"></script>
    <script src="/js/ex.header.js"></script>

    <script>
      const ph = '/img/placeholder.png'; // รูป placeholder (สร้างหรือเปลี่ยนตามที่มี)
      (async () => {
        try {
          const res = await fetch('/page/backend/ex_meetings_list.php', {
            credentials: 'include',
            cache: 'no-store'
          });
          const raw = await res.text();
          console.log('meetings raw:', raw);

          let data;
          try { data = JSON.parse(raw); }
          catch (e) {
            document.getElementById('empty').textContent = 'แปลงข้อมูลไม่สำเร็จ';
            return;
          }

          if (!data || data.ok !== true) {
            document.getElementById('empty').textContent = data && data.error ? data.error : 'โหลดข้อมูลไม่สำเร็จ';
            return;
          }

          const arr = data.meetings || [];
          if (!arr.length) {
            document.getElementById('empty').textContent = 'ยังไม่มีนัดหมาย';
            return;
          }

          const html = arr.map(m => {
            const reqImg = m.req_thumb || ph;
            const offImg = m.off_thumb || ph;
            const fromTxt = (m.from_province || m.from_district || m.from_subdistrict)
              ? `จ.${m.from_province || '-'} อ.${m.from_district || '-'} ต.${m.from_subdistrict || '-'}`
              : `-`;

            return `
              <div class="meeting-card">
                <div class="row">
                  <div class="left">
                    <img class="thumb" src="${reqImg}" alt="">
                    <span>↔</span>
                    <img class="thumb" src="${offImg}" alt="">
                  </div>
                  <div style="flex:1">
                    <div class="title">${m.req_title || ''} ↔ ${m.off_title || ''}</div>
                    <div class="meta">สถานะ: ${m.status || '-'}</div>
                    <div class="meta">วันเวลา: ${m.meet_when || m.scheduled_at || '-'}</div>
                    <div class="meta">สถานที่: ${m.meet_place || m.place || '-'}</div>
                    <div class="meta">หมายเหตุ: ${m.meet_note || m.note || '-'}</div>
                    <div class="meta">${fromTxt}</div>
                  </div>
                </div>
              </div>`;
          }).join('');

          document.getElementById('list').innerHTML = html;
          document.getElementById('empty').style.display = 'none';
        } catch (err) {
          console.error(err);
          document.getElementById('empty').textContent = 'โหลดข้อมูลไม่สำเร็จ';
        }
      })();
    </script>
  </body>
</html>
